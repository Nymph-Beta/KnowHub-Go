å¥½çš„ï¼Œéµç…§æ‚¨çš„è¦æ±‚ï¼Œæˆ‘å°†ä¿æŒæ‰€æœ‰æ–‡å­—å†…å®¹ä¸å˜ï¼Œä»…å¯¹ Markdown æ ¼å¼è¿›è¡Œä¼˜åŒ–å’Œè§„èŒƒåŒ–ï¼Œä½¿å…¶ç»“æ„æ›´æ¸…æ™°ã€æ›´åˆç†ã€‚

---

## å¤ç° and å­¦ä¹  PaiSmart_Goé¡¹ç›®

-   **ç›®çš„**ï¼šå­¦ä¹ goè¯­è¨€ç‰¹æ€§ï¼Œä¸javaåŒºåˆ«ï¼ŒRAGç›¸å…³åŠŸèƒ½çš„è‡ªå·±å®ç°

### é˜¶æ®µ1 é¡¹ç›®åˆå§‹åŒ–ä¸é…ç½®ç®¡ç†

-   **ä»»åŠ¡**ï¼š æ­å»ºé¡¹ç›®éª¨æ¶ï¼Œè®©ç¨‹åºèƒ½å¤Ÿè¯»å–é…ç½®æ–‡ä»¶

#### 1. æ€è€ƒç›®å½•ç»“æ„

å‚è€ƒGoé¡¹ç›®çš„æ ‡å‡†ç›®å½•ç»“æ„å‚è€ƒï¼š[golang-standards/project-layout](https://github.com/golang-standards/project-layout/blob/master/README_zh.md) - Go ç¤¾åŒºæ¨èçš„é¡¹ç›®ç»“æ„ã€‚

ä»ä¸­äº†è§£åˆ° `/cmd`ã€`/internal`ï¼Œ`/pkg`ï¼Œ`/verndor` ç›®å½•åŒºåˆ«ï¼š

-   `cmd` é¡¹ç›®çš„ä¸»å¹²ã€‚
-   `internal` ç§æœ‰åº”ç”¨ç¨‹åºå’Œåº“ä»£ç ã€‚
-   `pkg` å¤–éƒ¨åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨çš„åº“ä»£ç ï¼Œå…¶ä»–é¡¹ç›®å¯ä»¥å¯¼å…¥è¿™äº›åº“ã€‚

#### 2. åˆå§‹åŒ–goæ¨¡å—

```bash
go mod init paismart-go-v2
```

#### 3. Viperé…ç½®åº“

Viper æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Go åº”ç”¨ç¨‹åºé…ç½®è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ 12-Factor åº”ç”¨ã€‚å®ƒæ—¨åœ¨é€‚ç”¨äºä»»ä½•åº”ç”¨ç¨‹åºï¼Œå¹¶èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„é…ç½®éœ€æ±‚å’Œæ ¼å¼ã€‚å¯è¢«è§†ä¸ºæ»¡è¶³æ‚¨åº”ç”¨ç¨‹åºæ‰€æœ‰é…ç½®éœ€æ±‚çš„æ³¨å†Œè¡¨ã€‚

```bash
go get github.com/spf13/viper
```

æ”¯æŒçš„é…ç½®æ–‡ä»¶æ ¼å¼å¤šæ ·ï¼ŒåŒ…æ‹¬jsonã€yamlã€tomlç­‰ã€‚

`viper.SetConfigFile()` å’Œ `viper.SetConfigName()` ç”¨äºå‘Šè¯‰viperå»å“ªé‡Œæ‰¾é…ç½®æ–‡ä»¶ï¼ŒåŒºåˆ«åœ¨äº`SetConfigName`ç”¨äºçµæ´»æŸ¥æ‰¾ï¼Œåªéœ€è¦æŒ‡å®šæ–‡ä»¶åçš„ä¸»ä½“ï¼Œæ ¹æ®`AddConfigPath()` è®¾ç½®çš„æœç´¢è·¯å¾„ï¼Œå»å¯»æ‰¾åŒåçš„æ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨å°è¯•æ‰€æœ‰æ”¯æŒçš„æ‰©å±•åï¼›`SetConfigFile`æ˜¾å¼æŒ‡å®šå®Œæ•´çš„æ–‡ä»¶è·¯å¾„ã€‚

Viper ä½¿ç”¨ `mapstructure` åº“æ¥å®ç°é…ç½®åˆ°ç»“æ„ä½“çš„ååºåˆ—åŒ–ã€‚

#### 4. è®¾è®¡é…ç½®ç»“æ„

å‚è€ƒåŸé¡¹ç›®ï¼Œé˜¶æ®µä¸€éœ€è¦çš„åŸºæœ¬é…ç½®éœ€è¦serverä¸‹çš„portå’Œmodã€‚

å…·ä½“çš„å®ç°åœ¨ï¼š

-   `configs/config.yaml`ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰
-   `internal/config/config.go`ï¼ˆé…ç½®ç»“æ„ä½“ + Init å‡½æ•°ï¼‰
-   `cmd/server/main.go`ï¼ˆè°ƒç”¨ Init å¹¶æ‰“å°é…ç½®ï¼‰

### é˜¶æ®µ 2: æ—¥å¿—ç³»ç»Ÿ & HTTP æœåŠ¡å™¨

#### 1. æ‰©å±•é…ç½®æ–‡ä»¶

å‚è€ƒåŸæœ‰é…ç½®ï¼Œå¹¶æ›´æ–° `internal/config/config.go` æ·»åŠ  `LogConfig` ç»“æ„ä½“ã€‚

-   `format`ï¼šæ§åˆ¶è¾“å‡ºæ ¼å¼ jsonä¾¿äºé‡‡é›†ï¼›consoleä¾¿äºé˜…è¯»
-   `level`ï¼šæ§åˆ¶æ—¥å¿—çº§åˆ«è¿‡æ»¤

**config.yamlæ›´æ–°ï¼š**

```yaml
log:
  level: "debug"
  format: "json"
  output_path: "./logs"
  error_output_path: "./logs/error.log"
  maxsize: 100
  maxbackups: 10
  maxage: 30
  compress: true
  time_format: "2006-01-02 15:04:05.000"
```

**config.goæ›´æ–°ï¼š**

```go
type LogConfig struct {
	Level           string `mapstructure:"level"`
	Format          string `mapstructure:"format"`
	OutputPath      string `mapstructure:"output_path"`
	ErrorOutputPath string `mapstructure:"error_output_path"`
	Maxsize         int    `mapstructure:"maxsize"`
	Maxbackups      int    `mapstructure:"maxbackups"`
	Maxage          int    `mapstructure:"maxage"`
	Compress        bool   `mapstructure:"compress"`
	TimeFormat      string `mapstructure:"time_format"`
}
```

#### 2. Zap æ—¥å¿—åº“

æˆªæ­¢åˆ°2026 å¹´ 1 æœˆï¼Œä¸€èˆ¬çš„goé¢„ç ”é¡¹ç›®ä¼šé‡‡ç”¨ï¼š`log/slog` (Go æ ‡å‡†åº“)ã€`uber-go/zap`ã€`rs/zerolog`ä¸‰è€…å…¶ä¸€ã€‚

-   **è®¡åˆ’**ï¼šå…ˆä½¿ç”¨zapæ¥å®ç°ï¼Œåç»­å¯æ¢ç”¨slogï¼Œä¸çŸ¥æ˜¯å¦å¯è¡Œã€‚

`zap.Logger`ï¼š**æå¿«**ï¼Œå†…å­˜åˆ†é…æå°‘ã€‚å®ƒä¸åšä»»ä½•ç±»å‹æ¨æ–­ï¼Œä¸ä½¿ç”¨åå°„ï¼›ä½†ä½ å¿…é¡»æ˜ç¡®å‘Šè¯‰å®ƒä½ ä¼ çš„æ˜¯ä»€ä¹ˆç±»å‹ã€‚

```go
// å¿…é¡»ç”¨ zap.String, zap.Int åŒ…è£…
logger.Info("ç™»å½•æˆåŠŸ", zap.String("user", "admin"), zap.Int("id", 123))
```

`zap.SugaredLogger`ï¼šåœ¨ `zap.Logger` å¤–é¢åŒ…è£¹äº†ä¸€å±‚â€œè¯­æ³•ç³–â€ï¼ˆSugarï¼‰ã€‚æ–¹ä¾¿ï¼Œæ”¯æŒ `printf` æ ¼å¼ï¼Œæ”¯æŒå¼±ç±»å‹ã€‚

```go
// åƒ fmt.Printf ä¸€æ ·çˆ½
sugar.Infof("ç™»å½•æˆåŠŸ user:%s id:%d", "admin", 123)
// æˆ–è€…ç”¨é”®å€¼å¯¹
sugar.Infow("ç™»å½•æˆåŠŸ", "user", "admin", "id", 123)
```

`zap.NewProductionConfig()` å’Œ `zap.NewDevelopmentConfig()` æ˜¯ Zap é¢„è®¾çš„ä¸¤å¥—â€œå¥—é¤â€ï¼Œåˆ†åˆ«å¯¹åº”**ä¸Šçº¿å**å’Œ**å†™ä»£ç æ—¶**çš„éœ€æ±‚ã€‚

| ç‰¹æ€§         | Production (ç”Ÿäº§ç¯å¢ƒ)       | Development (å¼€å‘ç¯å¢ƒ)        |
| :----------- | :-------------------------- | :---------------------------- |
| **æ ¼å¼**     | **JSON** (æœºå™¨å¥½è¯»)         | **Console** (äººçœ¼å¥½è¯»)        |
| **é»˜è®¤çº§åˆ«** | **Info** (å¿½ç•¥ Debug)       | **Debug** (å…¨æ‰“å°)            |
| **é¢œè‰²**     | æ— é¢œè‰²                      | **æœ‰é¢œè‰²** (Debugç°, Errorçº¢) |
| **æ—¶é—´æ ¼å¼** | Unix æ—¶é—´æˆ³ (å¦‚ 167888...)  | ISO8601 (å¦‚ 2023-01-01...)    |
| **å †æ ˆè·Ÿè¸ª** | åªæœ‰ Error/Fatal æ‰æ‰“å°å †æ ˆ | Warn ä»¥ä¸Šå°±æ‰“å°å †æ ˆ           |

`log.Sync()`å¦‚æœç¨‹åºçªç„¶é€€å‡ºï¼ˆæ— è®ºæ˜¯æ­£å¸¸ç»“æŸï¼Œè¿˜æ˜¯ Panic å´©æºƒï¼Œè¿˜æ˜¯è¢« `kill`ï¼‰ï¼Œç¼“å†²åŒºé‡Œå¯èƒ½è¿˜æœ‰æœ€åå‡ åæ¡æ—¥å¿—**åœ¨å†…å­˜é‡Œæ²¡æ¥å¾—åŠå†™åˆ°ç¡¬ç›˜**ã€‚å®ƒæŠŠç¼“å†²åŒºé‡Œå‰©ä¸‹çš„ä¸œè¥¿å…¨éƒ¨å¼ºåˆ¶å†™åˆ°ç¡¬ç›˜é‡Œã€‚

`defer` ä¿è¯äº†æ— è®ºå‡½æ•°æ˜¯æ­£å¸¸æ‰§è¡Œå®Œï¼Œè¿˜æ˜¯ä¸­é—´å‡ºäº†é”™å´©æºƒäº†ï¼Œ`Sync()` **ä¸€å®šä¼š**åœ¨ç¨‹åºé€€å‡ºçš„æœ€åä¸€åˆ»è¢«æ‰§è¡Œã€‚

**æ›´æ–°ï¼š**

-   **config.yaml**ï¼šæ›´æ–°logç›¸å…³é…ç½®
-   **config.go**ï¼šæ›´æ–°logç›¸å…³typeæ˜ å°„
-   æ–°å»º **log.go**ï¼šå®ç°zapçš„å®ç°ï¼Œå…ˆå®ç°æ—¥å¿—çº§åˆ«è®¾ç½®ï¼›é…ç½®ç¼–ç æ ¼å¼å’Œå¼€å‘ç¯å¢ƒï¼›è®¾ç½®è¾“å‡ºç›®å½•ã€‚æœ€åæ„å»ºloggerï¼Œå¹¶å®ç°wrapperåŒ…è£…
-   æ›´æ–° **main.go**ï¼šåˆå§‹åŒ–logï¼Œå¹¶æ–°å»ºä¸€ä¸ªtestå‡½æ•°æµ‹è¯•

#### 3. Ginæ¡†æ¶ï¼Œå®ç°ä¸­é—´ä»¶

Ginæ˜¯ä¸€ä¸ªwebå¼€å‘æ¡†æ¶ï¼Œæä¾›ç±»ä¼¼Martiniçš„APIï¼Œä½†æ€§èƒ½æ›´ä½³ã€‚å®ƒå°è£…äº†åº•å±‚é€»è¾‘ï¼Œä»£ç æ›´ç®€æ´ã€‚è¯¥é¡¹ç›®ä¸­Gin è´Ÿè´£æ¥æ”¶å‰ç«¯è¯·æ±‚ã€è°ƒç”¨çš„ä¸šåŠ¡é€»è¾‘ã€æœ€åè¿”å›ç»“æœç»™å‰ç«¯çš„æ ¸å¿ƒéª¨æ¶ã€‚

ginæœ¬èº«æœ‰è‡ªå·±çš„é»˜è®¤æ¶æ„ã€‚å¯ä»¥å¯¹æ¯”**`gin.Default()`**å’Œ**`gin.New()` + è‡ªå®šä¹‰**ã€‚

æ ¸å¿ƒåŒºåˆ«æ˜¯ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰ã€‚

**`gin.Default()`**é€‚åˆå†™ Demo æˆ–ç®€å•é¡¹ç›®ï¼Œé»˜è®¤çš„Loggeræ ¼å¼æ˜¯å›ºå®šçš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦å°†æ—¥å¿—è¾“å‡ºä¸º JSON æ ¼å¼å¹¶å­˜å…¥æ–‡ä»¶ï¼ˆä¸ºäº†ç»™ ELKã€ES ç­‰ç³»ç»Ÿåˆ†æï¼‰ï¼Œé»˜è®¤çš„ Logger æ»¡è¶³ä¸äº†éœ€æ±‚ã€‚

`gin.New()` å› ä¸ºè¯¥é¡¹ç›®ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„zapæ—¥å¿—æ ¼å¼ã€‚æ­¤æ—¶çš„ `r` æ˜¯ä¸€å¼ ç™½çº¸ã€‚å¦‚æœä½ ç›´æ¥è¿è¡Œï¼Œæ—¢æ²¡æœ‰æ—¥å¿—ï¼Œä»£ç  panicï¼ˆå´©æºƒï¼‰äº†æœåŠ¡ä¹Ÿä¼šç›´æ¥é€€å‡ºï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ è®¾è®¡ä¸­é—´ä»¶ã€‚

å¯¹äºä¸­é—´ä»¶çš„è®¾è®¡ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯**å‰ç½®å¤„ç†ï¼ˆè¯·æ±‚åˆšè¿›æ¥ï¼‰**ã€**æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆ`c.Next()`ï¼‰**ã€**åç½®å¤„ç†ï¼ˆå“åº”è¿”å›æ—¶ï¼‰**ã€‚å¦‚æœä½ è°ƒç”¨ `c.Next()`ï¼Œæˆ–è€…åœ¨ `c.Next()` ä¹‹å‰å°±æ‰“å°æ—¥å¿—ï¼Œä½ å°±**æ‹¿ä¸åˆ°**çœŸå®çš„çŠ¶æ€ç å’Œè€—æ—¶ã€‚åªæœ‰ç­‰ `c.Next()` è¿”å›äº†ï¼Œæ‰ä»£è¡¨åé¢çš„ä¸šåŠ¡è·‘å®Œäº†ã€‚

å³ï¼šä¸­é—´ä»¶A (å‰ç½®ä»£ç ) -> **è°ƒç”¨ `c.Next()`** -> æš‚åœ Aï¼Œè¿›å…¥ B ä¸­é—´ä»¶B (å‰ç½®ä»£ç ) -> **è°ƒç”¨ `c.Next()`** -> æš‚åœ Bï¼Œè¿›å…¥ä¸šåŠ¡ **ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ** (è¿”å›æ•°æ®) -> **å›åˆ° B** (æ‰§è¡Œ `c.Next()` åçš„ä»£ç ) -> **å›åˆ° A** (æ‰§è¡Œ `c.Next()` åçš„ä»£ç )ã€‚

**ä¸­é—´ä»¶çš„è¯¦ç»†è®¾è®¡**

1.  `bodyLogWriter` ç”¨äºæ•è·å“åº”ä½“ï¼Œé€šè¿‡*åµŒå…¥ Gin åŸç”Ÿçš„ Writerï¼Œç»§æ‰¿å®ƒæ‰€æœ‰åŠŸèƒ½ï¼ˆStatus(), Header() ç­‰ï¼‰*ï¼Œå¹¶ä¸”è‡ªå¸¦è®°å½•çš„body `bytes.Buffer`ã€‚
2.  ä¹‹åé‡å†™`Write`æ–¹æ³•ï¼Œ*å½“ä¸šåŠ¡ä»£ç è°ƒç”¨ c.JSON() æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯è¿™ä¸ª Write*ï¼Œå°†å“åº”å†™å…¥ `gin.ResponseWriter` å’Œä¸€ä¸ªå†…éƒ¨çš„ bufferã€‚
3.  ä¹‹å`RequestLogger`åˆ†ä¸ºä¸‰æ­¥ï¼Œ**Read**: `ioutil.ReadAll` ä¼šæŠŠæµè¯»ç©ºã€‚**Restore**: `bytes.NewBuffer` æŠŠè¯»å‡ºæ¥çš„å­—èŠ‚å˜æˆä¸€ä¸ªæ–°çš„ Readerã€‚`ioutil.NopCloser` æŠŠå®ƒåŒ…è£…æˆç¬¦åˆ `ReadCloser` æ¥å£çš„å¯¹è±¡ã€‚**Assign**: èµ‹å€¼å› `c.Request.Body`ï¼Œè¿™æ ·åç»­çš„ä¸šåŠ¡é€»è¾‘å®Œå…¨æ„Ÿè§‰ä¸åˆ° Body å·²ç»è¢«è¯»è¿‡ä¸€æ¬¡äº†ã€‚
4.  ä½¿ç”¨è‡ªå®šä¹‰çš„ `ResponseWriter` æ•è·å“åº”ï¼Œä¹‹åæ‰€æœ‰ `c.JSON/c.String` çš„è¾“å‡ºéƒ½ä¼šç»è¿‡ `blw.Write`ã€‚

> **éšæ‚£**ï¼šä»£ç é‡Œ `ioutil.ReadAll(c.Request.Body)` ä¼šæŠŠæ•´ä¸ª Body è¯»å…¥å†…å­˜ã€‚å¦‚æœç”¨æˆ·ä¸Šä¼ äº†ä¸€ä¸ª **500MB çš„æ–‡ä»¶**ï¼Œè¿™ä¸ªä¸­é—´ä»¶ä¼šç¬é—´æ¶ˆè€— 500MB å†…å­˜æ¥å­˜æ—¥å¿—ã€‚ï¼ˆä¹‹åè§£å†³ï¼Ÿï¼‰
>
> **ä½ çš„æ‹…å¿§æ˜¯å¯¹çš„ï¼ è¿™åœ¨é˜¶æ®µäºŒæ˜¯ OK çš„ï¼Œä½†åœ¨é˜¶æ®µ 7ï¼ˆåˆ†ç‰‡ä¸Šä¼ ï¼‰éœ€è¦ç‰¹æ®Šå¤„ç†**

**æ›´æ–°ï¼š**

-   åˆ›å»ºä¸­é—´ä»¶`logging.go`
-   **main.go**: æ›´æ–°ginç›¸å…³é…ç½®ï¼Œå¯åŠ¨

#### 4. ä¼˜é›…åœæœº

å¼€å§‹ä½¿ç”¨çš„æ˜¯`r.Run(":" + cfg.Server.Port)`ã€‚å®ƒå†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨ `http.ListenAndServe`ï¼Œä½†æ— æ³•æ§åˆ¶å…³é—­æµç¨‹ï¼Œå› ä¸ºå®ƒä¸è¿”å› `http.Server` å¯¹è±¡ã€‚

æ‰€ä»¥éœ€è¦**æ‰‹åŠ¨åˆ›å»º** `http.Server` å¯¹è±¡ï¼Œå³ç”³è¯·åˆ†é…ä¸€ä¸ª `http.Server` ç»“æ„ä½“çš„å†…å­˜åœ¨ `Addr` å’Œ `Handler` è¿™ä¸¤ä¸ªæ ¼å­é‡Œå†™ä¸Šæ•°æ®ã€‚

```go
srv := &http.Server{
    Addr:    fmt.Sprintf(":%s", cfg.Server.Port),
    Handler: r, // æŠŠ Gin çš„å¼•æ“ä¼ è¿›å»
}
```

ä¹‹åä½¿ç”¨ `if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed `ï¼Œå¹¶ä¸”ä½¿ç”¨`go func`ï¼Œå› ä¸º `srv.ListenAndServe()` æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¦‚æœä¸æŠŠå®ƒä¸¢åˆ°å­åç¨‹ï¼ˆgoroutineï¼‰é‡Œï¼Œä»£ç å°±ä¼šå¡æ­»åœ¨è¿™ä¸€è¡Œï¼Œæ°¸è¿œèµ°ä¸åˆ°ä¸‹é¢çš„â€œç›‘å¬åœæœºä¿¡å·â€çš„ä»£ç ã€‚

`err != http.ErrServerClosed` å½“æˆ‘ä»¬ç¨åä¸»åŠ¨è°ƒç”¨ `srv.Shutdown()` å…³é—­æœåŠ¡æ—¶ï¼Œ`ListenAndServe` ä¼šè¿”å›ä¸€ä¸ªç‰¹å®šçš„é”™è¯¯ `http.ErrServerClosed`ã€‚è¿™æ˜¯æ­£å¸¸çš„å…³é—­æµç¨‹ï¼Œä¸æ˜¯æ•…éšœã€‚

ä¹‹ååˆ›å»ºé€šé“ï¼Œç”¨æ¥æ¥æ”¶ç³»ç»Ÿä¿¡å·ã€‚é€šè¿‡`signal.Notify `é€šçŸ¥å¦‚æœæ”¶åˆ° SIGINT (Ctrl+C) æˆ– SIGTERM (Docker/K8s åœæ­¢å®¹å™¨)ï¼Œ ä¸è¦ç›´æ¥killï¼Œè€Œæ˜¯æŠŠä¿¡å·å‘åˆ° quit é€šé“é‡Œã€‚
**SIGINT (Signal Interrupt)**é€šå¸¸æ˜¯ç»ˆç«¯æŒ‰ä¸‹äº† **`Ctrl + C`**ã€‚**SIGTERM (Signal Terminate)**é€šå¸¸æ˜¯ **Dockerã€Kubernetes** æˆ– `kill` å‘½ä»¤ï¼ˆé»˜è®¤ä¸å¸¦å‚æ•°æ—¶ï¼‰ã€‚

**æ›´æ–°ï¼š**

- åœ¨main.goä¸­å®ç°ä¼˜é›…åœæœº

### é˜¶æ®µ3ï¼šæ•°æ®åº“è¿æ¥ & ç”¨æˆ·æ¨¡å‹ 

#### 1. å¯åŠ¨MySqlæœåŠ¡

åŸé¡¹ç›®ä½¿ç”¨Docker composeå¯åŠ¨MySQLï¼Œé…ç½®åœ¨ `deployments/docker-compose.yaml`

è¯¥æ–‡ä»¶å®šä¹‰äº†Paismarté¡¹ç›®ä¸­æ‰€æœ‰åŸºç¡€è®¾æ–½æœåŠ¡ï¼Œé€šè¿‡ Docker Compose ä¸€é”®å¯åŠ¨æ•´ä¸ªç¯å¢ƒ

- `docker-compose.yaml`ä¸­çš„å‚æ•°ï¼š

| å‚æ•°                | å€¼           | å«ä¹‰                              |
| :------------------ | :----------- | :-------------------------------- |
| container_name      | mysql        | å®¹å™¨åç§°ï¼Œæ–¹ä¾¿è¯†åˆ«å’Œç®¡ç†          |
| image               | mysql:8      | ä½¿ç”¨ MySQL 8.x å®˜æ–¹é•œåƒ           |
| restart             | always       | å®¹å™¨é€€å‡ºåè‡ªåŠ¨é‡å¯ï¼ˆé™¤éæ‰‹åŠ¨åœæ­¢) |
| MYSQL_ROOT_PASSWORD | PaiSmart2025 | è®¾ç½® root ç”¨æˆ·å¯†ç                 |
| MYSQL_DATABASE      | PaiSmart     | å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºçš„æ•°æ®åº“å      |

| éƒ¨åˆ† | å«ä¹‰                         |
| :--- | :--------------------------- |
| 3307 | å®¿ä¸»æœºç«¯å£ï¼ˆä½ çš„ç”µè„‘ï¼‰       |
| 3306 | å®¹å™¨å†…ç«¯å£ï¼ˆMySQL é»˜è®¤ç«¯å£ï¼‰ |

- æ£€æŸ¥MySqlæ˜¯å¦å¯åŠ¨

```cmd
docker ps | grep mysql
# æˆ–è€…æŸ¥çœ‹ docker-compose çŠ¶æ€
cd ~/Projects/paismart-go/deployments && docker compose ps
```

- æ£€æŸ¥æ•°æ®åº“åå’Œå¯†ç 

```cmd
docker inspect mysql --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -i mysql
```

------

#### 2: æ‰©å±•é…ç½®æ–‡ä»¶

ä»»åŠ¡ï¼šåœ¨ config.yaml ä¸­æ·»åŠ æ•°æ®åº“é…ç½®

æ€è€ƒï¼š

- åŸé¡¹ç›®çš„æ•°æ®åº“é…ç½®åœ¨ configs/config.yaml çš„å“ªé‡Œï¼Ÿ

- DSN (Data Source Name) çš„æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ

- ä¸ºä»€ä¹ˆ DSN ä¸­æœ‰ parseTime=Trueï¼Ÿ

```yaml
# configs/config.yaml - éœ€è¦æ·»åŠ ä»€ä¹ˆï¼Ÿ
database:
 mysql:
  dsn: "ç”¨æˆ·å:å¯†ç @åè®®(ä¸»æœº:ç«¯å£)/æ•°æ®åº“å?å‚æ•°" # å‚è€ƒåŸé¡¹ç›®æ ¼å¼
```
MySQL é©±åŠ¨é»˜è®¤æŠŠ DATE/DATETIME/TIMESTAMP å½“ []byte æˆ– string è¿”å›ï¼Œä¸ä¼šè‡ªåŠ¨è½¬æˆ Go çš„ time.Timeã€‚åŠ ä¸Š parseTime=True åï¼Œé©±åŠ¨ä¼šæŠŠè¿™äº›ç±»å‹è§£ææˆ time.Time ã€‚
ä»£ç é‡Œå¯ä»¥ç›´æ¥ç”¨ time.Time åšæ¯”è¾ƒã€æ ¼å¼åŒ–ã€è®¡ç®—ã€‚GORM ç­‰ ORM çš„ time.Time å­—æ®µèƒ½æ­£ç¡®æ˜ å°„åˆ°æ•°æ®åº“çš„æ—¥æœŸæ—¶é—´ç±»å‹

ç„¶åï¼šæ›´æ–° internal/config/config.go æ·»åŠ  DatabaseConfig ç»“æ„ä½“

#### 3. GORMæ¡†æ¶
GORM æ˜¯ Go è¯­è¨€ä¸­æœ€æµè¡Œçš„ ORMï¼ˆObject-Relational Mappingï¼Œå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯è®©ä½ ç”¨ Go çš„ç»“æ„ä½“æ¥æ“ä½œæ•°æ®åº“ï¼Œè€Œä¸ç”¨å†™å¤§é‡çš„åŸç”Ÿ SQLã€‚

åŒºåˆ«ï¼š
- æ²¡æœ‰ ORMï¼šéœ€è¦æ‰‹å†™ SQLï¼ˆSELECT * FROM users WHERE id = ?ï¼‰ï¼Œç„¶åæ‰‹åŠ¨æŠŠæŸ¥è¯¢ç»“æœæ˜ å°„åˆ° Go ç»“æ„ä½“
- æœ‰ GORMï¼šä½ ç›´æ¥æ“ä½œ Go ç»“æ„ä½“ï¼ŒGORM è‡ªåŠ¨ç”Ÿæˆ SQL å¹¶å®Œæˆæ˜ å°„
```go
// æ²¡æœ‰ GORM - æ‰‹å†™ SQL + æ‰‹åŠ¨æ‰«æ
rows, _ := db.Query("SELECT id, name, email FROM users WHERE id = ?", 1)
var user User
rows.Scan(&user.ID, &user.Name, &user.Email)

// æœ‰ GORM - ä¸€è¡Œæå®š
db.First(&user, 1)  // è‡ªåŠ¨ç”Ÿæˆ SELECT * FROM users WHERE id = 1
```

ä¹‹åå¯ä»¥è‡ªå®šä¹‰ç”¨æˆ·æ¨¡å‹å’Œæ‰§è¡ŒCRUDæ“ä½œ

å¹¶ä¸”å¯ä»¥å’ŒGinç»“åˆï¼š
```go
r.GET("/users/:id", func(c *gin.Context) {
    var user User
    if err := db.First(&user, c.Param("id")).Error; err != nil {
        c.JSON(404, gin.H{"error": "ç”¨æˆ·ä¸æ‰¾åˆ°"})
        return
    }
    c.JSON(200, user)
})
```

æ›´æ–°ï¼š\cmd\server\gorm_demo

##### æ³¨æ„ï¼š
gormä¸­çš„æ—¥å¿—è®°å½•æ˜¯å†…ç½®çš„æ—¥å¿—ç³»ç»Ÿï¼Œé»˜è®¤è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆæ§åˆ¶å°ï¼‰ã€‚ä½†åœ¨è¯¥é¡¹ç›®ä¸­æ—¥å¿—è®°å½•æ˜¯å°è£…zap:`import "pai_smart_go_v2/pkg/log"`

å¦‚æœæƒ³è®© GORM ä½¿ç”¨ zapï¼Œæˆ‘ä½¿ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ `moul.io/zapgorm2` ç¬¬ä¸‰æ–¹åº“ï¼Œå¯ä»¥å°† GORM çš„æ—¥å¿—æ¡¥æ¥åˆ° zap ã€‚åœ¨`log.go`ä¸­æ›´æ–°ï¼šé€šè¿‡ `GetLogger()` å¯¼å‡ºåŸå§‹çš„` *zap.Logger`
```go
zapLogger = logger // æ–°å¢ï¼šå¯¼å‡ºåŸå§‹ logger
sugarLogger = logger.Sugar()

func GetLogger() *zap.Logger {
	return zapLogger
}
```
#### 4. è®¾è®¡Useræ¨¡å‹ã€

å‚è€ƒæ•°æ®åº“ä¸­æ•°æ®ç±»å‹æ¥å†™

æ›´æ–°ï¼š`user.go`

å…·ä½“ç»†èŠ‚ï¼š
- `gorm:"primaryKey;autoIncrement` : å£°æ˜ä¸»é”®ä»¥åŠä¸»é”®è‡ªå¢ã€‚å³æ’å…¥æ—¶ä¸å†™ IDï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨åˆ†é…ä¸‹ä¸€ä¸ªæ•´æ•°ã€‚
- `json:"-"`ï¼šåºåˆ—åŒ–æˆ JSON æ—¶å¿½ç•¥è¯¥å­—æ®µï¼Œå³ä½¿ç”¨ json.Marshal(user) æˆ–æ¡†æ¶è‡ªåŠ¨æŠŠ User è½¬ JSONï¼Œä¹Ÿä¸ä¼šæŠŠ Password è¿”å›ç»™å‰ç«¯ï¼Œé¿å…å¯†ç æ³„éœ²ã€‚
- `gorm:"autoCreateTime"` å’Œ ` gorm:"autoUpdateTime" `ï¼šåˆ›å»ºæ—¶è‡ªåŠ¨è®¾ä¸ºå½“å‰æ—¶é—´ã€‚æ’å…¥æ–°è®°å½•æ—¶ï¼Œä¸ç”¨æ‰‹åŠ¨å¡« CreatedAtï¼ŒGORM ä¼šå¸®ä½ å†™ã€‚æ¯æ¬¡æ›´æ–°æ—¶è‡ªåŠ¨åˆ·æ–°ä¸ºå½“å‰æ—¶é—´ã€‚åªè¦æ‰§è¡Œ Update/Saveï¼ŒUpdatedAt å°±ä¼šæ›´æ–°ã€‚
- `TableName() `ï¼šGORM é»˜è®¤ç”¨ç»“æ„ä½“åçš„å¤æ•°ã€è›‡å½¢æ¥çŒœè¡¨åï¼š`User â†’ users`ã€‚å®ç° `TableName()` å¯ä»¥æ˜¾å¼æŒ‡å®šè¡¨åï¼Œä¾‹å¦‚å›ºå®šä¸º `"users"`ã€‚
-  Role å­—æ®µä¸ºä»€ä¹ˆç”¨ enumï¼Ÿ :`gorm:"type:enum('USER', 'ADMIN');default:'USER'" `è¡¨ç¤ºåœ¨æ•°æ®åº“é‡Œè¯¥åˆ—æ˜¯ MySQL ENUM ç±»å‹ï¼Œåªå…è®¸ `USER` æˆ– `ADMIN`ï¼Œé»˜è®¤ `USER`ã€‚

| è®¾è®¡ç‚¹                     | ä½œç”¨                                     |
| :------------------------- | :--------------------------------------- |
| ä¸»é”® + è‡ªå¢                | å”¯ä¸€æ ‡è¯†æ¯æ¡ç”¨æˆ·ï¼Œä¸”ä¸ç”¨æ‰‹å†™ IDã€‚        |
| å”¯ä¸€ + éç©ºï¼ˆå¦‚ Usernameï¼‰ | ç™»å½•åä¸é‡å¤ã€å¿…å¡«ã€‚                     |
| å¯†ç  json:"-"              | ä¸åœ¨ä»»ä½• JSON é‡Œè¾“å‡ºï¼Œä¿æŠ¤å¯†ç ã€‚         |
| Role ç”¨ enum               | è§’è‰²åªåœ¨æœ‰é™é›†åˆå†…ï¼Œæ•°æ®åº“å’Œä»£ç éƒ½ä¸€è‡´ã€‚ |
| CreatedAt / UpdatedAt      | è‡ªåŠ¨è®°å½•åˆ›å»ºä¸ä¿®æ”¹æ—¶é—´ï¼Œä¾¿äºæ’æŸ¥å’Œå®¡è®¡ã€‚ |
| TableName()                | æ˜ç¡®è¡¨åä¸º usersï¼Œä¸ä¾èµ– GORM é»˜è®¤è§„åˆ™ã€‚ |

æ•´ä½“ä¸Šï¼Œè¿™å¼ è¡¨åšåˆ°äº†ï¼šæœ‰å”¯ä¸€ä¸»é”®ã€æœ‰åˆ›å»º/ä¿®æ”¹æ—¶é—´ã€æ•æ„Ÿå­—æ®µä¸å‡ºç½‘ã€è§’è‰²æœ‰çº¦æŸï¼Œæ˜¯å¸¸è§çš„ç”¨æˆ·è¡¨è®¾è®¡æ–¹å¼ã€‚

#### 5. å®ç°æ•°æ®åº“è¿æ¥æ¨¡å—

æ›´æ–°ï¼šåˆ›å»º `pkg/database/mysql.go`
- ä½¿ç”¨å…¨å±€å˜é‡DBï¼š ä¸ºäº†â€œå…¨è¿›ç¨‹å…±ç”¨ä¸€ä¸ª DB å®ä¾‹ã€å„å¤„ç›´æ¥ç”¨â€ï¼Œå±äºå•ä¾‹å¼çš„è®¾è®¡ã€‚
- è¿æ¥å¤±è´¥æ—¶è°ƒç”¨ `log.Fatal` : æ‰“æ—¥å¿—å¹¶è°ƒç”¨ os.Exit(1)ï¼Œè¿›ç¨‹ç›´æ¥é€€å‡ºã€‚åç»­å¯æ›´æ”¹è®¾è®¡ï¼Œä½¿å…¶æ›´çµæ´»
- è¿æ¥æ± ï¼š ç¨‹åºå¯åŠ¨åé¢„å…ˆå»ºå¥½ä¸€æ‰¹åˆ° MySQL çš„ TCP è¿æ¥ï¼Œæ”¾åœ¨æ± å­é‡Œï¼›æ¯æ¬¡è¦æ‰§è¡Œ SQL æ—¶ä»æ± é‡Œå–ä¸€æ¡è¿æ¥ç”¨ï¼Œç”¨å®Œåè¿˜å›æ± é‡Œï¼Œè€Œä¸æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½æ–°å»ºã€ç”¨å®Œå°±å…³ã€‚

è®¾è®¡æ€è·¯ï¼š
- å¯åŠ¨æ—¶åˆå§‹åŒ–ã€å…¨è¿›ç¨‹å•ä¾‹
InitMySQL(dsn) åœ¨ main é‡Œè°ƒç”¨ä¸€æ¬¡ï¼ŒæˆåŠŸåæŠŠ *gorm.DB å­˜åˆ°åŒ…çº§å˜é‡ DBï¼Œåç»­æ‰€æœ‰ä¸šåŠ¡é€šè¿‡ database.DB è®¿é—®ï¼Œä¸å†é‡å¤å»ºè¿ã€‚
- æŠŠã€Œèƒ½å¦æ­£å¸¸æœåŠ¡ã€å’Œã€Œè¿åº“æ˜¯å¦æˆåŠŸã€ç»‘å®š
è¿ä¸ä¸Šå°± log.Fatal é€€å‡ºï¼Œä¿è¯è¿›ç¨‹é‡Œåªè¦å­˜åœ¨ï¼Œå°±è®¤ä¸º DB å·²ç»å¯ç”¨ï¼Œä¸åšã€ŒDB æœªåˆå§‹åŒ–ä»ç»§ç»­è·‘ã€çš„å¤æ‚åˆ†æ”¯ã€‚
- æ˜¾å¼é…ç½®è¿æ¥æ± ï¼Œé¢å‘å¸¸é©»è¿›ç¨‹
ç”¨ DB.DB() æ‹¿åˆ°åº•å±‚ *sql.DBï¼Œè®¾ç½® MaxIdleConnsã€MaxOpenConnsã€ConnMaxLifetimeï¼Œé€‚åˆå¤šè¯·æ±‚å¹¶å‘çš„é•¿é©»æœåŠ¡ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§è„šæœ¬ã€‚
- åŒ…èŒè´£å•ä¸€
pkg/database åªè´Ÿè´£ã€Œå»ºè¿ + é…ç½®è¿æ¥æ±  + æš´éœ² DBã€ï¼Œä¸å…³å¿ƒä¸šåŠ¡å’Œè·¯ç”±ï¼Œæ–¹ä¾¿åœ¨ main é‡Œå…ˆ config â†’ log â†’ database å†èµ· HTTPã€‚
æ•´ä½“ä¸Šï¼šç”¨å…¨å±€ DB å•ä¾‹ + å¯åŠ¨æ—¶ä¸€æ¬¡åˆå§‹åŒ– + å¤±è´¥å³ Fatal + è¿æ¥æ± é…ç½®ï¼Œæ˜¯å°å‹/ä¸­å‹ Go æœåŠ¡é‡Œå¾ˆå¸¸è§çš„ä¸€ç§ç®€å•ã€æ¸…æ™°çš„æ•°æ®åº“æ¥å…¥æ–¹å¼ã€‚

**æ³¨æ„ï¼š**

å¯¹äºæ˜¯å¦é‡‡ç”¨ä¹‹å‰å®ç°çš„zapLogger + GetLogger()æ¥è®°å½•
- ä»…å°±ã€Œåˆå§‹åŒ–è¿™æ®µä»£ç ã€æœ¬èº«ï¼Œè¿™é‡Œå‡ ä¹ä¸ä¼šæ‰§è¡Œä¸šåŠ¡ SQLï¼Œæ‰€ä»¥è¿™æ®µåˆå§‹åŒ–ä»£ç æœ¬èº«ä¸ä¾èµ– zapLogger + GetLogger() ä¹Ÿèƒ½æŠŠè¯¥è®°çš„è®°å…¨ã€‚åªä¸ºâ€œåˆå§‹åŒ– MySQL è¿™å‡ è¡Œâ€çš„è¯ï¼Œä¸åŠ  zapLogger + GetLogger() ä¹Ÿå¤Ÿç”¨ã€‚
- ä»ã€Œæ•´æ¡é“¾è·¯æ—¥å¿—éƒ½è¿› zapã€çš„è§’åº¦ï¼Œè‹¥å¸Œæœ›â€œæ‰€æœ‰ GORM SQL éƒ½è¿› zapâ€ï¼Œå°±éœ€è¦åœ¨åˆå§‹åŒ–æ—¶åŠ ä¸Š zapLogger + GetLogger()ï¼ˆåœ¨ gorm.Open æ—¶ä¼ å…¥ zapgorm2ï¼‰ã€‚
**è¿™é‡Œéœ€è¦ä¹‹åæ€è€ƒ**

#### 6. å®ç° AutoMigrate
è¯¥ç¯èŠ‚ä¸åŸé¡¹ç›®å®ç°ä¸åŒï¼š
1. cmd/server/main.go é‡Œæ²¡æœ‰ AutoMigrate
    åœ¨ `main.go` é‡Œåªæœ‰ï¼š`database.InitMySQL(cfg.Database.MySQL.DSN)`
    æ²¡æœ‰ä»»ä½• `database.DB.AutoMigrate(...)` æˆ–å…¶å®ƒè¿ç§»è°ƒç”¨ã€‚
    `pkg/database/mysql.go` é‡Œçš„ `InitMySQL` ä¹Ÿåªåšè¿æ¥å’Œè¿æ¥æ± é…ç½®ï¼Œæ²¡æœ‰æ‰§è¡Œè¿ç§»ã€‚

2. é¡¹ç›®é‡Œçš„â€œè‡ªåŠ¨å»ºè¡¨â€æ˜¯åœ¨å“ªé‡Œåšçš„
    é¡¹ç›®æ²¡æœ‰ç”¨ GORM è‡ªåŠ¨å»ºè¡¨ï¼Œè€Œæ˜¯ç”¨ MySQL å®¹å™¨é¦–æ¬¡å¯åŠ¨æ—¶æ‰§è¡Œ DDLï¼š
    åœ¨ `deployments/docker-compose.yaml` é‡Œæœ‰ï¼š`docker-compose.yaml`
    MySQL å®˜æ–¹é•œåƒä¼šåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶æ‰§è¡Œ /docker-entrypoint-initdb.d/ ä¸‹çš„ .sql æ–‡ä»¶ã€‚

  å› æ­¤ï¼š
  è‡ªåŠ¨å»ºè¡¨ = æŠŠ docs/ddl.sql æŒ‚åˆ° docker-entrypoint-initdb.d/001-ddl.sqlï¼Œç”± MySQL åœ¨å®¹å™¨é¦–æ¬¡åˆå§‹åŒ–æ—¶æ‰§è¡Œï¼Œåˆ›å»º usersã€organization_tagsã€file_uploadã€chunk_infoã€document_vectors ç­‰è¡¨ã€‚

  ä¹Ÿå°±æ˜¯è¯´ï¼šâ€œè‡ªåŠ¨å»ºè¡¨â€æ˜¯åœ¨ Docker éƒ¨ç½²é‡Œé€šè¿‡ MySQL çš„ init è„šæœ¬ï¼ˆdocs/ddl.sqlï¼‰å®ç°çš„ï¼Œä¸æ˜¯åœ¨ Go ä»£ç é‡Œç”¨ AutoMigrate å®ç°çš„ã€‚

å®ç°æ€è·¯ï¼š
1. å­¦ä¹  GORM å®Œæ•´èƒ½åŠ›
    AutoMigrate æ˜¯ GORM çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå¾ˆå¤šé¡¹ç›®ï¼ˆç‰¹åˆ«æ˜¯å°å‹é¡¹ç›®ï¼‰éƒ½ç”¨å®ƒ
2. å¼€å‘æ›´æ–¹ä¾¿
    æ”¹ struct â†’ é‡å¯ç¨‹åº â†’ è¡¨ç»“æ„è‡ªåŠ¨æ›´æ–°ï¼Œä¸ç”¨æ¯æ¬¡æ”¹ SQL æ–‡ä»¶
3. åç»­å¯ä»¥åˆ‡æ¢
    ç†è§£åŸç†åï¼Œç”Ÿäº§éƒ¨ç½²æ—¶å¯ä»¥æ”¹å› DDL æ–¹å¼ï¼Œä¸¤ç§æ–¹å¼ä¸å†²çª

**åŸé¡¹ç›®æ–¹å¼**ï¼šé€šè¿‡ `docs/ddl.sql` + Docker æŒ‚è½½å®ç°
- ä¼˜ç‚¹ï¼šç”Ÿäº§ç¯å¢ƒæ›´å®‰å…¨ï¼Œå®Œå…¨æ§åˆ¶è¡¨ç»“æ„
- ç¼ºç‚¹ï¼šéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ SQL å’Œ Model ä¸€è‡´æ€§

**æœ¬é¡¹ç›®é€‰æ‹©**ï¼šå¼€å‘é˜¶æ®µä½¿ç”¨ `db.AutoMigrate()`
- ä¼˜ç‚¹ï¼šå­¦ä¹  GORM èƒ½åŠ›ï¼Œå¼€å‘è¿­ä»£æ–¹ä¾¿
- æ³¨æ„ï¼šç”Ÿäº§éƒ¨ç½²æ—¶å¯è€ƒè™‘åˆ‡æ¢ä¸º DDL æ–‡ä»¶æ–¹å¼

å…·ä½“å®ç°ï¼š
- åœ¨ `pkg/database/mysql.go` æœ«å°¾æ·»åŠ `RunMigrations()`,
```go
// RunMigrations æ‰§è¡Œæ•°æ®åº“è¡¨ç»“æ„è¿ç§»ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼‰
// ä½¿ç”¨ GORM AutoMigrate æ ¹æ® model è‡ªåŠ¨åˆ›å»º/æ›´æ–°è¡¨ç»“æ„
func RunMigrations() error {
	log.Info("å¼€å§‹æ‰§è¡Œæ•°æ®åº“è¡¨ç»“æ„è¿ç§»...")

	// æŒ‰ç…§ä¾èµ–é¡ºåºè¿ç§»è¡¨
	if err := DB.AutoMigrate(
		&model.User{},
		// åç»­é˜¶æ®µä¼šç»§ç»­æ·»åŠ ï¼š
		// &model.OrgTag{},          // é˜¶æ®µ 5
		// &model.Upload{},          // é˜¶æ®µ 6-7
		// &model.ChunkInfo{},       // é˜¶æ®µ 7
		// &model.DocumentVector{},  // é˜¶æ®µ 10
	); err != nil {
		log.Errorf("AutoMigrate å¤±è´¥: %v", err)
		return err
	}

	log.Info("æ•°æ®åº“è¡¨ç»“æ„è¿ç§»å®Œæˆ")
	return nil
}
```
- åœ¨ `cmd/server/main.go` çš„ `database.InitMySQL(...)` åé¢æ·»åŠ ï¼š`database.RunMigrations()`
- æ–°å»ºæ•°æ®åº“ä¸ºPaiSmart_v2
- åœ¨å¼€å‘æœ€ååˆ‡æ¢ä¸º Docker æŒ‚è½½æ–¹å¼

### é˜¶æ®µå›› ç”¨æˆ·è®¤è¯ï¼ˆJWTï¼‰
#### 1. ç†è§£åˆ†å±‚æ¶æ„

åŸé¡¹ç›®ä¸­çš„ä¸‰å±‚æ¶æ„è®¾è®¡ï¼š
- Handlerå±‚ï¼š åªè´Ÿè´£HTTPåè®®ã€‚è´Ÿè´£è§£æè¯·æ±‚ä½“ã€è°ƒç”¨Serviceã€æ ¼å¼åŒ–å“åº”
- Serviceå±‚ï¼š ä¸šåŠ¡é€»è¾‘ç¼–æ’ã€‚è´Ÿè´£åè°ƒå¤šä¸ªRepositoryã€å®ç°ä¸šåŠ¡è§„åˆ™ï¼ˆå¯†ç éªŒè¯ã€Tokenç”Ÿæˆï¼‰ã€äº‹åŠ¡ç®¡ç†
- Respositoryå±‚ï¼š åªè´Ÿè´£æ•°æ®åº“æ“ä½œã€‚è´Ÿè´£æ‰§è¡ŒSQLæŸ¥è¯¢ã€ORMæ˜ å°„ã€è¿”å›æ•°æ®æ¨¡å‹


å¦‚æœä¸ä½¿ç”¨ä¸‰å±‚æ¶æ„ï¼Œç›´æ¥åœ¨Handleré‡Œå†™SQLï¼Œä¼šå¯¼è‡´ï¼š
- ğŸ”´ æ— æ³•å¤ç”¨ï¼šå¦‚æœå¦ä¸€ä¸ªHandlerä¹Ÿéœ€è¦ç™»å½•é€»è¾‘ï¼Œå¿…é¡»å¤åˆ¶ç²˜è´´
- ğŸ”´ éš¾ä»¥æµ‹è¯•ï¼šè¦æµ‹è¯•ç™»å½•é€»è¾‘ï¼Œå¿…é¡»å¯åŠ¨æ•´ä¸ªHTTPæœåŠ¡å™¨
- ğŸ”´ ç´§è€¦åˆï¼šä¿®æ”¹æ•°æ®åº“æŸ¥è¯¢æ–¹å¼ï¼Œå¿…é¡»æ”¹æ‰€æœ‰Handler
- ğŸ”´ å¯è¯»æ€§å·®ï¼šä¸€ä¸ªå‡½æ•°åŒ…å«HTTPã€ä¸šåŠ¡ã€æ•°æ®åº“é€»è¾‘ï¼Œè¶…è¿‡100è¡Œ

ä¸¾ä¾‹è¯´æ˜ï¼š
- ä»£ç å¤ç”¨ï¼š `FindByUsername`å‡½æ•°è¢«å¤šä¸ªåœ°æ–¹è°ƒç”¨ï¼Œå¦‚æœåœ¨Handlerä¸­å†™SQLï¼Œä¼šå¤šæ¬¡å¤åˆ¶
- ä¸šåŠ¡é€»è¾‘æœç”¨ï¼š æ¯”å¦‚ç”¨æˆ·æ³¨å†Œé€»è¾‘ï¼Œè¯¥æµç¨‹è®¾è®¡å¤šä¸ªRepositoryå’Œæ•°æ®åº“æ“ä½œï¼Œè‹¥ä¸ä½¿ç”¨ä¸‰å±‚æ¶æ„ï¼Œé€»è¾‘å¾ˆè‡ƒè‚¿
- å•å…ƒæµ‹è¯•ï¼š åˆ†å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•æ¯ä¸€å±‚
- æŠ€æœ¯æ ˆè¿ç§»ï¼š å‡è®¾æœªæ¥è¦æŠŠæ•°æ®åº“ä»MySQLæ¢æˆPostgreSQLï¼šåˆ†å±‚æ¶æ„åªéœ€ä¿®æ”¹ Repository å®ç° ï¼ŒHandler å’Œ Service æ— éœ€æ”¹åŠ¨

ä¸ºä»€ä¹ˆ Repository è¦å®šä¹‰æ¥å£ï¼ˆinterfaceï¼‰ï¼Ÿ
- ä¸ºäº†ä»¥æ¥å€’ç½®å’Œå¯æµ‹è¯•æ€§ã€‚
- Serviceä¾èµ–çš„æ˜¯æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°ï¼Œæ¯”å¦‚ç”¨æˆ·æ³¨å†Œï¼Œå¯ä»¥ä¼ å…¥ä»»ä½•å®ç°`UserRespository`çš„å¯¹è±¡
- å¯ä»¥è½»æ¾åˆ‡æ¢å®ç°ï¼ˆMySqlæˆ–postgreSQLç­‰ï¼‰
- å•å…ƒæµ‹è¯•ä¸éœ€è¦æ•°æ®åº“

```go
Repository â†’ Service â†’ Handler
     â†“          â†“         â†“
   æ•°æ®è®¿é—®   ä¸šåŠ¡é€»è¾‘   HTTPå¤„ç†
```

####  2. æ‰©å±•é…ç½®æ–‡ä»¶
æ›´æ–°ï¼š config.yaml
```yaml
jwt:
  secret: "JWT ç­¾åå¯†é’¥, ä¸€ä¸ª Base64 ç¼–ç çš„ 32 å­—èŠ‚ï¼ˆ256 ä½ï¼‰éšæœºæ•°æ®ï¼Œé€šå¸¸é€šè¿‡ openssl rand -base64 32 ä¹‹ç±»çš„å‘½ä»¤ç”Ÿæˆã€‚"
  access_token_expire_hours: Access Token è¿‡æœŸæ—¶é—´, ç”¨æˆ·æ¯æ¬¡è¯·æ±‚ API æ—¶æºå¸¦çš„çŸ­æœŸå‡­è¯ï¼Œç”¨äºèº«ä»½éªŒè¯ã€‚
  refresh_token_expire_days: Refresh Token è¿‡æœŸæ—¶é—´, ç”¨äºåœ¨ Access Token è¿‡æœŸåï¼Œå…ç™»å½•åœ°è·å–æ–°çš„ Access Tokenã€‚å®ƒå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼ˆé€šå¸¸æ˜¯ HttpOnly Cookie æˆ–å®‰å…¨å­˜å‚¨ä¸­ï¼‰ï¼Œç”Ÿå‘½å‘¨æœŸæ›´é•¿ã€‚
```

#### 3. å®ç°å¯†ç åŠ å¯†æ¨¡å—

æ›´æ–°ï¼šæ–°å¢ `pkg/hash/bcrypy.go`
å‚è€ƒèµ„æ–™ï¼š`https://pkg.go.dev/golang.org/x/crypto/bcrypt`

ä½¿ç”¨ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š
```go
func HashPassword(password string) (string, error) {
  hashedPassword, err := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
}
func CheckPasswordHash(password, hash string) bool {
  return bcrypt.CompareHashAndPassword([]byte(hash), []byte(password)) == nil
}
```

- bcrypt.DefaultCost æ˜¯ golang.org/x/crypto/bcrypt åŒ…ä¸­å®šä¹‰çš„å¸¸é‡ï¼Œå€¼ä¸º 10ã€‚å®ƒä»£è¡¨ bcrypt ç®—æ³•çš„å·¥ä½œå› å­ï¼ˆwork factorï¼‰ï¼Œå³å†…éƒ¨å“ˆå¸Œè¿­ä»£æ¬¡æ•°çš„æŒ‡æ•°ï¼šå®é™…è¿­ä»£æ¬¡æ•°ä¸º 2^cost æ¬¡
- cost ç”¨äºå¯¹æŠ—ç¡¬ä»¶æå‡ã€å¯è°ƒèŠ‚æ—¶é—´æˆæœ¬ã€å¹¶ä¸”å¯ä»¥å‘å‰å…¼å®¹ã€‚
- ç›¸æ¯”äºMD5/SHA256ï¼Œbcryptä¸“ä¸ºå¯†ç å­˜å‚¨è®¾è®¡ã€‚é€šè¿‡costè°ƒèŠ‚é€Ÿåº¦ï¼Œè‡ªåŠ¨ç”Ÿæˆå¹¶åµŒå…¥ç»“æœä¸­ï¼Œå¹¶ä¸”bcrypt å†…å­˜è®¿é—®æ¨¡å¼å¯¹ GPU ä¸å‹å¥½

CheckPasswordHash ä¸ºä»€ä¹ˆè¿”å› bool è€Œä¸æ˜¯ errorï¼Ÿ
åº•å±‚çš„ `bcrypt.CompareHashAndPassword` å®é™…ä¸Šæ˜¯è¿”å› `error` çš„â€”â€”å¯†ç ä¸åŒ¹é…æ—¶è¿”å› bcrypt.ErrMismatchedHashAndPasswordï¼Œæ ¼å¼é”™è¯¯æ—¶ä¹Ÿä¼šè¿”å›ç›¸åº”çš„ `error`ã€‚

è¿™é‡Œå°è£…æˆ bool æ˜¯ä¸€ä¸ªæœ‰æ„çš„ç®€åŒ–è®¾è®¡ï¼ŒåŸå› æ˜¯ï¼š
- è°ƒç”¨æ–¹åªå…³å¿ƒ"å¯¹ä¸å¯¹"ï¼šåœ¨ç™»å½•åœºæ™¯ä¸­ï¼Œä¸è®ºæ˜¯å¯†ç é”™è¯¯è¿˜æ˜¯å“ˆå¸Œæ ¼å¼æŸåï¼Œå¯¹ç”¨æˆ·çš„å“åº”éƒ½æ˜¯ä¸€æ ·çš„â€”â€”"è®¤è¯å¤±è´¥"ã€‚åŒºåˆ†å…·ä½“é”™è¯¯ç±»å‹å¯¹ä¸šåŠ¡é€»è¾‘æ²¡æœ‰æ„ä¹‰ï¼Œåè€Œä¼šå¢åŠ è°ƒç”¨æ–¹çš„ä»£ç å¤æ‚åº¦ã€‚
- å®‰å…¨è€ƒé‡ï¼šå‘å¤–æš´éœ²å…·ä½“çš„é”™è¯¯ç±»å‹ï¼ˆå¦‚"å“ˆå¸Œæ ¼å¼æ— æ•ˆ" vs "å¯†ç ä¸åŒ¹é…"ï¼‰å¯èƒ½ç»™æ”»å‡»è€…æä¾›ä¿¡æ¯æ³„éœ²çš„æœºä¼šï¼ˆä¿¡æ¯æšä¸¾æ”»å‡»ï¼‰ã€‚
- API ç®€æ´æ€§ï¼š`if !CheckPasswordHash(pwd, hash)` æ¯” `if err := CheckPasswordHash(pwd, hash); err != nil` æ›´ç›´è§‚ã€‚


#### 4. å®ç° JWT æ¨¡å—

æ–°å»ºï¼š `pkg/token/jwt.go` `pkg/token/jwt_test.go`

JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´ä»¥ JSON å¯¹è±¡ çš„å½¢å¼å®‰å…¨ä¼ è¾“ä¿¡æ¯ã€‚å®ƒé€šè¿‡æ•°å­—ç­¾åï¼ˆHMACã€RSA æˆ– ECDSAï¼‰æ¥ä¿è¯ä¿¡æ¯å¯éªŒè¯ã€å¯ä¿¡ä»»ã€‚

ä½¿ç”¨åœºæ™¯ï¼š
- æˆæƒï¼ˆAuthorizationï¼‰ï¼šç”¨æˆ·ç™»å½•åï¼Œåç»­æ¯ä¸ªè¯·æ±‚æºå¸¦ JWTï¼ŒæœåŠ¡ç«¯æ®æ­¤åˆ¤æ–­æ˜¯å¦å…è®¸è®¿é—®èµ„æºã€‚
- ä¿¡æ¯äº¤æ¢ï¼šç­¾åç¡®ä¿å‘é€æ–¹èº«ä»½å’Œå†…å®¹æœªè¢«ç¯¡æ”¹ã€‚

ä¸»è¦ç»“æ„æ˜¯ä¸‰æ®µå¼ï¼š

ä¸€ä¸ª JWT ï¼šxxxxx.yyyyy.zzzzzï¼Œç”± . åˆ†éš”ä¸ºä¸‰éƒ¨åˆ†ï¼š

| éƒ¨åˆ†      | å†…å®¹           | è¯´æ˜                                                    |
| :-------- | :------------- | :------------------------------------------------------ |
| Header    | ç®—æ³• + ç±»å‹    | å¦‚ {"alg": "HS256", "typ": "JWT"}                       |
| Payload   | Claimsï¼ˆå£°æ˜ï¼‰ | ç”¨æˆ·ä¿¡æ¯ã€è¿‡æœŸæ—¶é—´ç­‰ï¼Œå¦‚ {"sub": "123", "name": "John"} |
| Signature | ç­¾å           | ç”¨ Header + Payload + å¯†é’¥ ç”Ÿæˆï¼Œé˜²ç¯¡æ”¹                 |

æ¯éƒ¨åˆ†éƒ½ç»è¿‡ Base64Url ç¼–ç ã€‚

ä¸»è¦å·¥ä½œæµç¨‹ï¼š
1. å®¢æˆ·ç«¯ç”¨è´¦å·å¯†ç ç™»å½•
2. æœåŠ¡ç«¯éªŒè¯åè¿”å›ä¸€ä¸ª JWT
3. å®¢æˆ·ç«¯ä¹‹åæ¯æ¬¡è¯·æ±‚åœ¨ Authorization: Bearer <token> å¤´ä¸­æºå¸¦è¯¥ JWT
4. æœåŠ¡ç«¯éªŒè¯ JWT æœ‰æ•ˆåï¼Œå…è®¸è®¿é—®å—ä¿æŠ¤èµ„æº

ä»£ç è®¾è®¡æ€è·¯ï¼š
```
å¯†é’¥ + è¿‡æœŸæ—¶é—´ â†’ å°è£…è¿›ä¸€ä¸ªç»“æ„ä½“ â†’ æš´éœ² Generate / Verify æ–¹æ³•
```

`pkg/token/jwt.go` åŸºäº `golang-jwt/jwt/v5` å®ç°ï¼Œæ ¸å¿ƒç»“æ„ï¼š

- **JWTManager**ï¼šå°è£…å¯†é’¥å’Œè¿‡æœŸæ—¶é—´ï¼Œæš´éœ² `GenerateToken` / `VerifyToken` ä¸¤ä¸ªæ–¹æ³•
- **CustomClaims**ï¼šåµŒå…¥ `jwt.RegisteredClaims`ï¼ˆæ ‡å‡†å­—æ®µ iss/exp/iat/nbfï¼‰ï¼Œæ‰©å±• UserIDã€Usernameã€Roleã€TokenType
- **åŒ Token æœºåˆ¶**ï¼š`GenerateToken` åŒæ—¶è¿”å› access tokenï¼ˆçŸ­æœŸï¼‰å’Œ refresh tokenï¼ˆé•¿æœŸï¼‰
- **ç­¾åç®—æ³•**ï¼šä½¿ç”¨ HMAC-SHA256ï¼ˆå¯¹ç§°å¯†é’¥ï¼Œç­¾åå’ŒéªŒè¯ç”¨åŒä¸€ä¸ª secretï¼‰

æ”¹åŠ¨è®°å½•ï¼š

1. **æ·»åŠ  TokenType å­—æ®µ**ï¼šCustomClaims å¢åŠ  `token_type` å­—æ®µï¼ˆå€¼ä¸º `"access"` æˆ– `"refresh"`ï¼‰ï¼Œé˜²æ­¢æ”»å‡»è€…æ‹¿ refresh token å†’å…… access token è°ƒç”¨ APIã€‚ä¸šåŠ¡å±‚ä¸­é—´ä»¶é€šè¿‡æ£€æŸ¥ `claims.TokenType` æ¥åŒºåˆ†ã€‚
2. **WithValidMethods æ›¿ä»£æ‰‹åŠ¨ç±»å‹æ–­è¨€**ï¼šVerifyToken ä¸­åŸå…ˆé€šè¿‡ `token.Method.(*jwt.SigningMethodHMAC)` æ‰‹åŠ¨æ£€æŸ¥ç®—æ³•ç±»å‹ï¼ˆå…è®¸ HS256/384/512 ä¸‰ç§ï¼‰ï¼Œæ”¹ä¸ºä½¿ç”¨ `jwt.WithValidMethods([]string{"HS256"})` ç²¾ç¡®é™åˆ¶åªå…è®¸ HS256ï¼Œæ›´ç¬¦åˆ v5 API é£æ ¼ï¼Œé˜²æ­¢ç®—æ³•ç¯¡æ”¹æ”»å‡»ã€‚


#### 5. å®ç° Repository å±‚
å…·ä½“å®ç°ï¼š `internal/repository/user_repository.go` `internal/repository/user_repository_test.go`

è®¾è®¡æ€è·¯ï¼š æ¥å£ + ç»“æ„ä½“å®ç°
1. æ¥å£å’Œå®ç°åˆ†ç¦»
  å…ˆå®šä¹‰ UserRepository æ¥å£ã€‚
  ```go
  type UserRepository interface {
   // å®šä¹‰çš„ç”¨æˆ·æ•°æ®çš„å„ä¸ªæŒä¹…åŒ–æ“ä½œ
  }
  ```
  å†å®šä¹‰userRepository ï¼š UserRepository æ¥å£çš„ GORM å®ç°ã€‚
  ```go
  type userRepository struct {
    db *gorm.DB
  }
  ```
  - UserRepositoryï¼ˆå¤§å†™ Uï¼‰ï¼šå…¬å¼€çš„æ¥å£ï¼Œå®šä¹‰"èƒ½åšä»€ä¹ˆ"
  - userRepositoryï¼ˆå°å†™ uï¼‰ï¼šç§æœ‰çš„ç»“æ„ä½“ï¼Œå®šä¹‰"æ€ä¹ˆåš"
  å¤–éƒ¨åŒ…åªèƒ½çœ‹åˆ°æ¥å£ï¼Œçœ‹ä¸åˆ°å…·ä½“å®ç°ã€‚è¿™å°±æ˜¯ Go çš„å°è£…æ–¹å¼ã€‚

2. å·¥å‚å‡½æ•°è¿”å›æ¥å£ç±»å‹
  ```go
  // NewUserRepository åˆ›å»ºä¸€ä¸ªæ–°çš„ UserRepository å®ä¾‹ã€‚
  func NewUserRepository(db *gorm.DB) UserRepository {
    return &userRepository{db: db}
  }
  ```
  NewUserRepository æ¥å—ä¸€ä¸ª *gorm.DB å‚æ•°ï¼Œè¿”å›çš„æ˜¯æ¥å£ç±»å‹ UserRepositoryï¼Œè€Œä¸æ˜¯å…·ä½“çš„ *userRepositoryã€‚è°ƒç”¨è€…æ°¸è¿œä¸çŸ¥é“åº•å±‚å®ç°æ˜¯ä»€ä¹ˆã€‚

  ä¼˜åŠ¿ï¼š
  1. è§£è€¦ â€”â€” Service å±‚ä¸ä¾èµ–å…·ä½“çš„æ•°æ®åº“å®ç°
    - Service åªçŸ¥é“"æœ‰ä¸€ä¸ª UserRepository æ¥å£ï¼Œå®ƒèƒ½ Createã€FindByUsername ç­‰"ï¼Œä½†å®Œå…¨ä¸çŸ¥é“åº•å±‚ç”¨çš„æ˜¯ GORMã€è¿˜æ˜¯åŸç”Ÿ SQLã€è¿˜æ˜¯ MongoDBã€‚è¿™å°±æ˜¯ä¾èµ–å€’ç½®åŸåˆ™ (DIP)ã€‚
  2. æ–¹ä¾¿æµ‹è¯•
    - å› ä¸º Service ä¾èµ–çš„æ˜¯æ¥å£ï¼Œåœ¨å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª Mock å®ç°ï¼Œä¸éœ€è¦è¿æ¥çœŸå®æ•°æ®åº“
  3. å¯æ›¿æ¢æ€§ â€”â€” æ¢æ•°æ®åº“åªæ”¹ Repository å±‚
---
#### 6. å®ç° Service å±‚

æ›´æ–°å†…å®¹ï¼š `internal/service/user_service.go`  `internal/service/user_service_test.go`

å…ˆå®Œæˆç”¨æˆ·ç›¸å…³ Service ï¼Œä¸å«ç»„ç»‡æ ‡ç­¾çš„é€»è¾‘

å®ç°ï¼š
```go
type UserService interface {
    Register(username, password string) (*model.User, error)
    Login(username, password string) (accessToken string, err error)
    GetProfile(username string) (*model.User, error)
}
```

Service å±‚å¤„äºä¸­é—´ä½ç½®ï¼Œå‘ä¸Šä¸º Handler æä¾›ç®€æ´çš„ä¸šåŠ¡æ¥å£ï¼ˆä¸€ä¸ªæ–¹æ³•è°ƒç”¨å®Œæˆæ•´ä¸ªä¸šåŠ¡ï¼‰ï¼Œå‘ä¸‹é€šè¿‡ç»„åˆå¤šä¸ª Repository å’Œå·¥å…·åŒ…æ¥å®ç°å¤æ‚çš„ä¸šåŠ¡æµç¨‹ã€‚

ç™»å½•å¤±è´¥åº”è¯¥è¿”å›"ç”¨æˆ·ä¸å­˜åœ¨"è¿˜æ˜¯"å‡­è¯æ— æ•ˆ"ï¼Ÿ
- åº”è¯¥ç»Ÿä¸€è¿”å›"å‡­è¯æ— æ•ˆ"ï¼ˆå³ ErrInvalidCredentialsï¼‰ï¼Œè¿™æ˜¯æ­£ç¡®çš„åšæ³•ã€‚å¦åˆ™å¯èƒ½ä¼šè¢«æšä¸¾æ”»å‡»ã€‚

Service å±‚åº”è¯¥è°ƒç”¨ log è®°å½•æ—¥å¿—å—ï¼Ÿ
- å¯¹äºç›®å‰çš„é¡¹ç›®é˜¶æ®µï¼Œå½“å‰åœ¨ Service é‡Œç›´æ¥ç”¨ log.Errorf æ˜¯å¯ä»¥çš„ï¼Œå…ˆæŠŠåŠŸèƒ½åšé€šã€‚ç­‰åç»­é¡¹ç›®å¤æ‚äº†ï¼Œå†è€ƒè™‘å°† logger æ”¹ä¸ºä¾èµ–æ³¨å…¥çš„æ–¹å¼ã€‚

#### 7. å®ç° Handler å±‚

æ›´æ–°ï¼š `internal/handler/user_handler.go` `internal/handler/user_handler_test.go`

```go
type UserHandler struct {
    userService service.UserService
}

// è¯·æ±‚ä½“ç»“æ„
type RegisterRequest struct {
    Username string `json:"username" binding:"required"`
    Password string `json:"password" binding:"required"`
}

// Handler æ–¹æ³•
func (h *UserHandler) Register(c *gin.Context) { ... }
func (h *UserHandler) Login(c *gin.Context) { ... }
func (h *UserHandler) GetProfile(c *gin.Context) { ... }
```

##### çŸ¥è¯†ç‚¹

**`binding:"required"` ä¸ Gin å‚æ•°éªŒè¯**

- ç»“æ„ä½“æ ‡ç­¾å¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨ç©ºæ ¼éš”å¼€ï¼š`json:"username"` è´Ÿè´£ JSON åºåˆ—åŒ–ï¼Œ`binding:"required"` è´Ÿè´£éªŒè¯ã€‚
- Gin åº•å±‚ä½¿ç”¨ [go-playground/validator](https://github.com/go-playground/validator) åº“ã€‚
- `binding:"required"` è¡¨ç¤ºå­—æ®µå¿…é¡»å­˜åœ¨ä¸”ä¸èƒ½ä¸ºé›¶å€¼ï¼ˆç©ºå­—ç¬¦ä¸²ã€0ã€nilï¼‰ã€‚
- å¸¸ç”¨éªŒè¯è§„åˆ™ç¤ºä¾‹ï¼š
  - `binding:"required,min=3,max=32"` â€” å¿…å¡«ï¼Œ3-32 å­—ç¬¦
  - `binding:"required,email"` â€” å¿…é¡»æ˜¯é‚®ç®±æ ¼å¼
  - `binding:"oneof=USER ADMIN"` â€” æšä¸¾å€¼é™åˆ¶
  - `binding:"omitempty,gte=0,lte=150"` â€” å¯é€‰ï¼Œä½†ä¼ äº†å°±å¿…é¡»åœ¨èŒƒå›´å†…

**`c.ShouldBindJSON()` vs `c.BindJSON()`**

- `ShouldBindJSON`ï¼šéªŒè¯å¤±è´¥åªè¿”å› errorï¼Œä¸è‡ªåŠ¨å†™å“åº”ï¼Œç”±å¼€å‘è€…è‡ªå·±æ§åˆ¶è¿”å›æ ¼å¼ã€‚**æ¨èä½¿ç”¨ã€‚**
- `BindJSON`ï¼šéªŒè¯å¤±è´¥ä¼šè‡ªåŠ¨è°ƒç”¨ `c.AbortWithError(400, err)` å†™ä¸€ä¸ªä¸å¯å®šåˆ¶çš„å“åº”ï¼Œå¤±å»æ§åˆ¶æƒã€‚
- ç»“è®ºï¼šå‡ ä¹æ‰€æœ‰æƒ…å†µéƒ½ç”¨ `Should` å‰ç¼€çš„æ–¹æ³•ï¼ˆ`ShouldBindJSON`ã€`ShouldBindQuery`ã€`ShouldBindUri`ï¼‰ã€‚

**HTTP çŠ¶æ€ç é€‰æ‹©**

| çŠ¶æ€ç  | å«ä¹‰ | æœ¬é¡¹ç›®åœºæ™¯ |
|-------|------|----------|
| 200 OK | è¯·æ±‚æˆåŠŸ | Login æˆåŠŸã€GetProfile æˆåŠŸ |
| 201 Created | æˆåŠŸåˆ›å»ºæ–°èµ„æº | Register æˆåŠŸ |
| 400 Bad Request | è¯·æ±‚æ ¼å¼é”™è¯¯ | JSON è§£æå¤±è´¥ã€ç¼ºå°‘å¿…å¡«å­—æ®µ |
| 401 Unauthorized | èº«ä»½éªŒè¯å¤±è´¥ | ç™»å½•å¯†ç é”™è¯¯ã€Token æ— æ•ˆ/è¿‡æœŸ |
| 403 Forbidden | æœ‰èº«ä»½ä½†æ²¡æƒé™ | æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜æ¥å£ |
| 404 Not Found | èµ„æºä¸å­˜åœ¨ | GetProfile æŸ¥æ— æ­¤ç”¨æˆ· |
| 409 Conflict | èµ„æºå†²çª | æ³¨å†Œæ—¶ç”¨æˆ·åå·²å­˜åœ¨ |
| 500 Internal Server Error | æœåŠ¡å™¨å†…éƒ¨å‡ºé”™ | æ•°æ®åº“æŒ‚äº†ã€Token ç”Ÿæˆå¤±è´¥ |

- 401 vs 403ï¼š401 æ˜¯"ä¸çŸ¥é“ä½ æ˜¯è°"ï¼ˆæœªè®¤è¯ï¼‰ï¼Œ403 æ˜¯"çŸ¥é“ä½ æ˜¯è°ä½†æ²¡æƒé™"ï¼ˆå·²è®¤è¯ä½†æœªæˆæƒï¼‰ã€‚

**Handler å±‚é”™è¯¯å¤„ç†è¦ç‚¹**

- ç”¨ `mapServiceError()` å°† Service å“¨å…µé”™è¯¯æ˜ å°„åˆ°æ­£ç¡®çš„ HTTP çŠ¶æ€ç ï¼Œé¿å…æ‰€æœ‰é”™è¯¯éƒ½è¿”å› 500ã€‚
- é”™è¯¯åˆ†æ”¯å¿…é¡» `return`ï¼Œå¦åˆ™ä¼šç»§ç»­æ‰§è¡ŒæˆåŠŸå“åº”ï¼Œå¯¼è‡´é‡å¤å†™å“åº”ã€‚
- å¯¹å¤–å“åº”ä¸åŒ…å« `err.Error()`ï¼Œé¿å…æ³„éœ²æ•°æ®åº“/å†…éƒ¨å®ç°ç»†èŠ‚ã€‚
- `c.Get()` è¿”å› `any` ç±»å‹ï¼Œä½¿ç”¨å‰éœ€è¦ç±»å‹æ–­è¨€ï¼š`user, ok := userVal.(*model.User)`ã€‚

#### 8. å®ç° Auth ä¸­é—´ä»¶
æ›´æ–°ï¼š`internal/middleware/auth.go`

##### æ•´ä½“æµç¨‹

```
è¯·æ±‚è¿›æ¥ â†’ [AuthMiddleware] â†’ é€šè¿‡ â†’ Handler å¤„ç†ä¸šåŠ¡
                â”‚
                â”œâ”€ 0. ä¾èµ–æ£€æŸ¥ï¼ˆjwtManager/userService æ˜¯å¦ä¸º nilï¼‰
                â”œâ”€ 1. æå– Bearer Token
                â”œâ”€ 2. éªŒè¯ Token ç­¾åå’Œæœ‰æ•ˆæœŸ
                â”œâ”€ 3. æ£€æŸ¥ Token ç±»å‹ï¼ˆå¿…é¡»æ˜¯ accessï¼‰
                â”œâ”€ 4. æŸ¥æ•°æ®åº“ç¡®è®¤ç”¨æˆ·å­˜åœ¨
                â”œâ”€ 5. æ³¨å…¥ claims å’Œ user åˆ°ä¸Šä¸‹æ–‡
                â””â”€ 6. c.Next() æ”¾è¡Œ
                â”‚
                â””â”€â†’ ä»»ä¸€æ­¥å¤±è´¥ â†’ AbortWithStatusJSON â†’ è¯·æ±‚åˆ°æ­¤ç»“æŸ
```

##### ç¬¬é›¶æ­¥ï¼šé˜²å¾¡æ€§æ£€æŸ¥

```go
if jwtManager == nil || userService == nil {
    c.AbortWithStatusJSON(http.StatusInternalServerError, ...)
    return
}
```
ç¡®ä¿ä¾èµ–å·²æ­£ç¡®æ³¨å…¥ï¼Œé˜²æ­¢åç»­ä»£ç  nil panicã€‚

##### ç¬¬ä¸€æ­¥ï¼šæå– Bearer Token

```go
tokenString, err := extractBearerToken(c.GetHeader("Authorization"))
```
ä» HTTP è¯·æ±‚å¤´ `Authorization: Bearer xxxxx` ä¸­æå–å‡º Token å­—ç¬¦ä¸²ã€‚Bearer æ˜¯ OAuth 2.0 / JWT çš„è¡Œä¸šæ ‡å‡†æ ¼å¼ã€‚

`extractBearerToken` çš„å®ç°æ”¹è¿›ï¼š
- ç”¨ `strings.Fields` æ›¿ä»£ `HasPrefix + TrimPrefix`ï¼Œè‡ªåŠ¨å¤„ç†å¤šä½™ç©ºæ ¼
- ç”¨ `strings.EqualFold` åšå¤§å°å†™ä¸æ•æ„Ÿæ¯”è¾ƒï¼Œå…¼å®¹ `bearer`ã€`BEARER` ç­‰å†™æ³•

##### ç¬¬äºŒæ­¥ï¼šéªŒè¯ Token

```go
claims, err := jwtManager.VerifyToken(tokenString)
if err != nil || claims == nil {
    c.AbortWithStatusJSON(http.StatusUnauthorized, ...)
    return
}
```
è°ƒç”¨ `jwtManager.VerifyToken` æ£€æŸ¥ Token ç­¾åæ˜¯å¦æ­£ç¡®ã€æ˜¯å¦è¿‡æœŸã€‚éªŒè¯å¤±è´¥å°± Abortï¼ˆä¸­æ­¢ï¼‰ï¼Œè¯·æ±‚åˆ°æ­¤ç»“æŸï¼Œä¸ä¼šåˆ°è¾¾ Handlerã€‚

##### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥ Token ç±»å‹

```go
if claims.TokenType != token.TokenTypeAccess {
    c.AbortWithStatusJSON(http.StatusUnauthorized, ...)
    return
}
```
å—ä¿æŠ¤æ¥å£åªæ¥å— access tokenï¼Œæ‹’ç» refresh tokenã€‚é˜²æ­¢æ”»å‡»è€…æ‹¿ refresh token å†’å…… access token æ¥è®¿é—® APIï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `jwt.go` ä¸­è¦åŒºåˆ† `TokenTypeAccess` å’Œ `TokenTypeRefresh`ï¼‰ã€‚

##### ç¬¬å››æ­¥ï¼šæŸ¥æ•°æ®åº“ç¡®è®¤ç”¨æˆ·å­˜åœ¨

```go
user, err := userService.GetProfile(claims.Username)
if err != nil {
    switch {
    case errors.Is(err, service.ErrUserNotFound):
        // ç”¨æˆ·å·²åˆ é™¤ â†’ 401
    default:
        // æ•°æ®åº“é”™è¯¯ â†’ 500ï¼ˆä¸æ³„éœ²ç»†èŠ‚ï¼‰
    }
    return
}
```
å³ä½¿ Token æœ‰æ•ˆï¼Œç”¨æˆ·ä¹Ÿå¯èƒ½å·²è¢«åˆ é™¤æˆ–ç¦ç”¨ï¼Œæ‰€ä»¥éœ€è¦æŸ¥ä¸€æ¬¡æ•°æ®åº“ç¡®è®¤ã€‚é”™è¯¯å¤„ç†ä½¿ç”¨ Service å±‚çš„å“¨å…µé”™è¯¯åšç²¾ç¡®åŒ¹é…ã€‚

##### ç¬¬äº”æ­¥ï¼šæ³¨å…¥ä¸Šä¸‹æ–‡ + æ”¾è¡Œ

```go
c.Set("claims", claims)  // åç»­ Handler é€šè¿‡ c.Get("claims") è·å– JWT Claims
c.Set("user", user)      // åç»­ Handler é€šè¿‡ c.Get("user") è·å– *model.User
c.Next()                  // æ”¾è¡Œï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ– Handler
```
æ³¨æ„ï¼š`c.Get("user")` è¿”å›çš„æ˜¯ `any` ç±»å‹ï¼ŒHandler ä¸­ä½¿ç”¨æ—¶éœ€è¦ç±»å‹æ–­è¨€ `user, ok := userVal.(*model.User)`ã€‚

##### å­¦åˆ°çš„çŸ¥è¯†ç‚¹

**Gin ä¸­é—´ä»¶çš„æ ¸å¿ƒ APIï¼š**
- `c.Abort()` â€” ä¸­æ­¢è¯·æ±‚é“¾ï¼Œåç»­çš„ä¸­é—´ä»¶å’Œ Handler éƒ½ä¸ä¼šæ‰§è¡Œ
- `c.AbortWithStatusJSON()` â€” ä¸­æ­¢ + å†™ JSON å“åº”ï¼Œä¸€æ­¥åˆ°ä½
- `c.Next()` â€” æ”¾è¡Œï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ– Handler
- `c.Set(key, value)` / `c.Get(key)` â€” åœ¨ä¸­é—´ä»¶å’Œ Handler ä¹‹é—´ä¼ é€’æ•°æ®

**`c.AbortWithStatusJSON()` vs `c.JSON()` çš„åŒºåˆ«ï¼š**

æ ¸å¿ƒåŒºåˆ«æ˜¯**æ˜¯å¦ä¸­æ­¢è¯·æ±‚é“¾**ï¼š
- `c.JSON()` â€” åªå†™ JSON å“åº”ï¼Œä¸å½±å“ä»£ç æµç¨‹ï¼Œåç»­ä¸­é—´ä»¶å’Œ Handler ç…§å¸¸æ‰§è¡Œ
- `c.AbortWithStatusJSON()` â€” å†™ JSON å“åº” + ä¸­æ­¢è¯·æ±‚é“¾ï¼Œåç»­ä¸­é—´ä»¶å’Œ Handler ä¸å†æ‰§è¡Œ

```
è¯·æ±‚ â†’ ä¸­é—´ä»¶A â†’ ä¸­é—´ä»¶B â†’ Handler

ä¸­é—´ä»¶A è°ƒ c.JSON() + return       â†’ ä¸­é—´ä»¶B ä¼šæ‰§è¡Œï¼ŒHandler ä¼šæ‰§è¡Œ
ä¸­é—´ä»¶A è°ƒ c.AbortWithStatusJSON() â†’ ä¸­é—´ä»¶B ä¸æ‰§è¡Œï¼ŒHandler ä¸æ‰§è¡Œ
```

ä½¿ç”¨åœºæ™¯ï¼š
- **ä¸­é—´ä»¶é‡Œ** â€” ç”¨ `c.AbortWithStatusJSON()`ï¼Œé˜»æ­¢è¯·æ±‚ç»§ç»­å¾€ä¸‹èµ°åˆ° Handler
- **Handler é‡Œ** â€” ç”¨ `c.JSON()` + `return`ï¼ŒHandler æ˜¯è¯·æ±‚é“¾æœ€åä¸€ç¯ï¼Œä¸éœ€è¦ Abort

æ³¨æ„ï¼š`c.Abort()` ä¸ä¼šç»ˆæ­¢å½“å‰å‡½æ•°çš„æ‰§è¡Œï¼Œå®ƒåªæ˜¯è®¾ç½®äº†ä¸€ä¸ªæ ‡å¿—ä½ã€‚æ‰€ä»¥ Abort åä»éœ€æ‰‹åŠ¨ `return`ï¼Œå¦åˆ™å½“å‰å‡½æ•°åé¢çš„ä»£ç è¿˜ä¼šè·‘ã€‚

**ä¸ºä»€ä¹ˆ Token è¦åŒºåˆ† access å’Œ refresh ç±»å‹ï¼Ÿ**
- access tokenï¼šçŸ­æœŸæœ‰æ•ˆï¼ˆå¦‚ 15 åˆ†é’Ÿï¼‰ï¼Œç”¨äºè®¿é—® API
- refresh tokenï¼šé•¿æœŸæœ‰æ•ˆï¼ˆå¦‚ 24 å°æ—¶ï¼‰ï¼Œä»…ç”¨äºæ¢å–æ–°çš„ access token
- å¦‚æœä¸åŒºåˆ†ï¼Œæ”»å‡»è€…æ‹¿åˆ° refresh token å°±èƒ½ç›´æ¥è®¿é—® APIï¼Œrefresh token çš„é•¿æœ‰æ•ˆæœŸä¼šæ”¾å¤§é£é™©

#### 9. æ³¨å†Œè·¯ç”±

æ›´æ–°ï¼š`cmd/server/main.go`

##### main å‡½æ•°æ•´ä½“æµç¨‹

```
1. åŠ è½½é…ç½® config.Init()
2. åˆå§‹åŒ–æ—¥å¿— log.Init()
3. è¿æ¥æ•°æ®åº“ database.InitMySQL() + RunMigrate()
4. ä¾èµ–æ³¨å…¥ Repository â†’ JWTManager â†’ Service â†’ Handler
5. åˆ›å»º Gin å¼•æ“ + å…¨å±€ä¸­é—´ä»¶
6. æ³¨å†Œè·¯ç”±
7. å¯åŠ¨ HTTP æœåŠ¡å™¨ + ä¼˜é›…åœæœº
```

##### ä¾èµ–æ³¨å…¥é“¾

ä¾èµ–æ³¨å…¥é¡ºåºä½“ç°äº†å„å±‚ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œ**ä»åº•å±‚åˆ°ä¸Šå±‚**ï¼š

```go
// 1. Repositoryï¼ˆæœ€åº•å±‚ï¼Œä¾èµ–æ•°æ®åº“è¿æ¥ï¼‰
userRepo := repository.NewUserRepository(database.DB)

// 2. JWT Managerï¼ˆç‹¬ç«‹ç»„ä»¶ï¼Œä»é…ç½®è¯»å–å¯†é’¥å’Œè¿‡æœŸæ—¶é—´ï¼‰
jwtManager := token.NewJWTManager(
    cfg.JWT.Secret,
    time.Duration(cfg.JWT.AccessTokenExpireHours) * time.Hour,
    time.Duration(cfg.JWT.RefreshTokenExpireDays) * 24 * time.Hour,
)

// 3. Serviceï¼ˆä¸šåŠ¡å±‚ï¼Œæ³¨å…¥ Repository å’Œ JWTManagerï¼‰
userService := service.NewUserService(userRepo, jwtManager)

// 4. Handlerï¼ˆæ¥å£å±‚ï¼Œæ³¨å…¥ Serviceï¼‰
userHandler := handler.NewUserHandler(userService)
```

æ³¨å…¥é“¾è·¯å›¾ï¼š
```
database.DB â†’ UserRepository â†’ UserService â†’ UserHandler
                                    â†‘
cfg.JWT     â†’ JWTManager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### åˆ›å»º Gin å¼•æ“ä¸å…¨å±€ä¸­é—´ä»¶

```go
gin.SetMode(cfg.Server.Mode)               // è®¾ç½®è¿è¡Œæ¨¡å¼ï¼ˆdebug/releaseï¼‰
r := gin.New()                              // åˆ›å»ºç©ºå¼•æ“ï¼ˆä¸å¸¦é»˜è®¤ä¸­é—´ä»¶ï¼‰
r.Use(middleware.RequestLogger(), gin.Recovery())  // æ³¨å†Œå…¨å±€ä¸­é—´ä»¶
```

- `gin.New()` vs `gin.Default()`ï¼š`Default()` è‡ªå¸¦ Logger å’Œ Recoveryï¼Œ`New()` æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ç”¨è‡ªå®šä¹‰çš„ `RequestLogger` æ›¿ä»£é»˜è®¤ Logger
- `gin.Recovery()` â€” æ•è· panicï¼Œé˜²æ­¢æœåŠ¡å´©æºƒï¼Œè¿”å› 500

##### è·¯ç”±æ³¨å†Œ

```go
// ç”¨æˆ·ç›¸å…³è·¯ç”±ï¼Œç»Ÿä¸€å‰ç¼€ /api/v1/users
users := r.Group("/api/v1/users")
{
    // å…¬å¼€è·¯ç”±ï¼ˆæ— éœ€è®¤è¯ï¼‰
    users.POST("/register", userHandler.Register)   // POST /api/v1/users/register
    users.POST("/login", userHandler.Login)          // POST /api/v1/users/login

    // å—ä¿æŠ¤è·¯ç”±ï¼ˆéœ€è¦è®¤è¯ï¼‰
    authed := users.Group("/")
    authed.Use(middleware.AuthMiddleware(jwtManager, userService))
    {
        authed.GET("/me", userHandler.GetProfile)    // GET /api/v1/users/me
    }
}
```

è·¯ç”±ç»“æ„ï¼š
```
/api/v1/users
â”œâ”€â”€ POST /register          â† å…¬å¼€ï¼Œæ— éœ€ Token
â”œâ”€â”€ POST /login             â† å…¬å¼€ï¼Œæ— éœ€ Token
â””â”€â”€ [AuthMiddleware]        â† éœ€è¦ Bearer Token
    â””â”€â”€ GET /me             â† å—ä¿æŠ¤ï¼Œè¿”å›å½“å‰ç”¨æˆ·ä¿¡æ¯
```

- `r.Group()` â€” åˆ›å»ºè·¯ç”±ç»„ï¼Œå…±äº«å‰ç¼€å’Œä¸­é—´ä»¶
- åªæœ‰ `authed` ç»„ä½¿ç”¨äº† `AuthMiddleware`ï¼Œæ‰€ä»¥ `/register` å’Œ `/login` ä¸éœ€è¦ Token
- æ³¨æ„ï¼š**è·¯ç”±æ³¨å†Œå¿…é¡»åœ¨ `r := gin.New()` ä¹‹å**ï¼Œå¦åˆ™ `r` æœªå®šä¹‰ä¼šç¼–è¯‘æŠ¥é”™

##### çŸ¥è¯†ç‚¹

**Gin è·¯ç”±ç»„ï¼ˆGroupï¼‰çš„ä½œç”¨ï¼š**
- å…±äº« URL å‰ç¼€ï¼š`r.Group("/api/v1/users")` ä¸‹çš„æ‰€æœ‰è·¯ç”±è‡ªåŠ¨å¸¦ `/api/v1/users` å‰ç¼€
- å…±äº«ä¸­é—´ä»¶ï¼š`authed.Use(AuthMiddleware)` åªå¯¹ `authed` ç»„å†…çš„è·¯ç”±ç”Ÿæ•ˆï¼Œä¸å½±å“å¤–é¢çš„å…¬å¼€è·¯ç”±
- å¯ä»¥åµŒå¥—ï¼šåœ¨ `users` ç»„å†…å†åˆ›å»º `authed` å­ç»„ï¼Œå®ç°"éƒ¨åˆ†è·¯ç”±éœ€è¦è®¤è¯"çš„æ•ˆæœ

**`gin.New()` vs `gin.Default()`ï¼š**
- `gin.Default()` = `gin.New()` + Logger ä¸­é—´ä»¶ + Recovery ä¸­é—´ä»¶
- å½“ä½ æœ‰è‡ªå®šä¹‰æ—¥å¿—ä¸­é—´ä»¶ï¼ˆå¦‚ `RequestLogger`ï¼‰æ—¶ï¼Œç”¨ `gin.New()` é¿å…é‡å¤æ—¥å¿—

### é˜¶æ®µäº” Redis é›†æˆ & ç»„ç»‡æ ‡ç­¾
#### 1. å¯åŠ¨ Redis å¹¶æ‰©å±•é…ç½®
è¯¥ç¯èŠ‚ä¸åŸé¡¹ç›®å®ç°ä¸åŒï¼š

1. åŸé¡¹ç›®çš„ Redis æ˜¯é€šè¿‡ `deployments/docker-compose.yaml` å¯åŠ¨çš„ Docker å®¹å™¨

    ```yaml
    redis:
      image: redis:7.2-alpine
      ports:
        - "6380:6379"
      command: redis-server --bind 0.0.0.0 --port 6379 --requirepass PaiSmart2025 --appendonly yes
    ```

    docker-compose ä¸­é…ç½®äº†ä»¥ä¸‹å‚æ•°ï¼š

    | å‚æ•° | å€¼ | å«ä¹‰ |
    | :--- | :--- | :--- |
    | `--bind 0.0.0.0` | ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ | å…è®¸å®¹å™¨å¤–éƒ¨è¿æ¥ |
    | `--port 6379` | å®¹å™¨å†…éƒ¨ç«¯å£ | Redis çš„é»˜è®¤ç«¯å£å°±æ˜¯ **6379** |
    | `--requirepass PaiSmart2025` | è®¿é—®å¯†ç  | å®¢æˆ·ç«¯è¿æ¥æ—¶å¿…é¡»æä¾› |
    | `--appendonly yes` | å¼€å¯ AOF æŒä¹…åŒ– | æ¯æ¬¡å†™æ“ä½œè¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤± |
    | `ports: "6380:6379"` | ç«¯å£æ˜ å°„ | å®¿ä¸»æœº 6380 â†’ å®¹å™¨å†… 6379 |

    ç„¶ååœ¨ `configs/config.yaml` ä¸­æ‰‹åŠ¨å¡«å†™å¯¹åº”çš„è¿æ¥ä¿¡æ¯ï¼š
    ```yaml
    redis:
      addr: "127.0.0.1:6380"  # å¯¹åº” docker-compose æ˜ å°„çš„å®¿ä¸»æœºç«¯å£
      password: "PaiSmart2025"  # å¯¹åº” --requirepass
      db: 0
    ```

    ä¹Ÿå°±æ˜¯è¯´ï¼šDocker å±‚å’Œåº”ç”¨å±‚å„è‡ªå†™äº†ä¸€ä»½é…ç½®ï¼Œé å¼€å‘è€…æ‰‹åŠ¨ä¿è¯ä¸€è‡´ã€‚

2. `redis.Options` ä¸­ `DB` å‚æ•°çš„å«ä¹‰

    Redis å†…ç½®äº† **16 ä¸ªé€»è¾‘æ•°æ®åº“**ï¼ˆç¼–å· 0-15ï¼‰ï¼Œå…±äº«åŒä¸€ä¸ª Redis å®ä¾‹çš„å†…å­˜ï¼Œä½†æ•°æ®äº’ç›¸éš”ç¦»ã€‚`DB` å‚æ•°æŒ‡å®šè¿æ¥å“ªä¸ªé€»è¾‘æ•°æ®åº“ï¼š
    - `DB: 0` â€” ç¬¬ 0 å·æ•°æ®åº“ï¼ˆé»˜è®¤å€¼ï¼‰
    - `DB: 1` â€” ç¬¬ 1 å·æ•°æ®åº“
    - ... ä»¥æ­¤ç±»æ¨åˆ° `DB: 15`

    å…¸å‹ç”¨é€”ï¼šåœ¨åŒä¸€ä¸ª Redis å®ä¾‹ä¸Šéš”ç¦»ä¸åŒä¸šåŠ¡çš„æ•°æ®ï¼ˆå¦‚ DB 0 ç»™ç¼“å­˜ï¼ŒDB 1 ç»™ sessionï¼‰ã€‚

**åŸé¡¹ç›®æ–¹å¼**ï¼šDocker å®¹å™¨å¯åŠ¨ Redis + docker-compose ä¸­é…ç½®å‚æ•°
- ä¼˜ç‚¹ï¼šå›¢é˜Ÿåä½œï¼Œä¸€é”® `docker compose up` å¯åŠ¨æ‰€æœ‰æœåŠ¡
- ç¼ºç‚¹ï¼šdocker-compose.yaml å’Œ config.yaml ä¸¤å¤„é…ç½®éœ€æ‰‹åŠ¨ä¿æŒä¸€è‡´

**æœ¬é¡¹ç›®é€‰æ‹©**ï¼šä½¿ç”¨ WSL æœ¬åœ°å·²å®‰è£…çš„ Redisï¼ˆsystemd æœåŠ¡ï¼‰ï¼Œä¸ä¾èµ– Docker
- ä¼˜ç‚¹ï¼šå¼€å‘è½»é‡ï¼Œç”¨åˆ°ä»€ä¹ˆå¯åŠ¨ä»€ä¹ˆï¼›åªç»´æŠ¤ config.yaml ä¸€ä»½é…ç½®
- æ³¨æ„ï¼šéƒ¨ç½²æ—¶å†ç»Ÿä¸€æ•´ç†åˆ° docker-compose.yaml

å½“å‰ç¯å¢ƒï¼š
```
WSL æœ¬åœ° Redis: 127.0.0.1:6379, æ— å¯†ç , systemd ç®¡ç† (redis-server.service)
Docker Redis:   127.0.0.1:6380, å¯†ç  PaiSmart2025 (åŸé¡¹ç›®åœ¨ç”¨ï¼Œäº’ä¸å¹²æ‰°)
```

v2 é¡¹ç›®ä½¿ç”¨ DB 1 è€Œéé»˜è®¤çš„ DB 0ï¼Œé¿å…ä¸ç»ˆç«¯æ‰‹åŠ¨æµ‹è¯•æˆ–å…¶ä»–å·¥å…·çš„æ•°æ®äº’ç›¸æ±¡æŸ“ã€‚

å…·ä½“å®ç°ï¼š

- æ›´æ–° `configs/config.yaml`ï¼Œåœ¨ `database` ä¸‹æ·»åŠ  `redis` é…ç½®ï¼š
```yaml
database:
  mysql:
    dsn: "root:PaiSmart2025@tcp(127.0.0.1:3307)/paismart_v2?parseTime=True"
  redis:
    addr: "127.0.0.1:6379"
    password: ""
    db: 1
```

- æ›´æ–° `internal/config/config.go`ï¼Œåœ¨ `DatabaseConfig` ä¸­æ·»åŠ  `RedisConfig`ï¼š
```go
type DatabaseConfig struct {
	MySQL MySQLConfig `mapstructure:"mysql"`
	Redis RedisConfig `mapstructure:"redis"`
}

type RedisConfig struct {
	Addr     string `mapstructure:"addr"`
	Password string `mapstructure:"password"`
	DB       int    `mapstructure:"db"`
}
```

- æ–°å»º `pkg/database/redis.go`ï¼Œå‚è€ƒåŸé¡¹ç›®å®ç° `InitRedis`ï¼š
```go
package database

import (
	"context"
	"github.com/go-redis/redis/v8"
	"pai_smart_go_v2/pkg/log"
)

var RDB *redis.Client

// InitRedis åˆå§‹åŒ– Redis å®¢æˆ·ç«¯è¿æ¥
func InitRedis(addr, password string, db int) {
	RDB = redis.NewClient(&redis.Options{
		Addr:     addr,
		Password: password,
		DB:       db,
	})

	ctx := context.Background()
	if err := RDB.Ping(ctx).Err(); err != nil {
		log.Fatal("failed to connect to redis", err)
	}

	log.Info("Redis client connected successfully")
}
```

- æ›´æ–° `cmd/server/main.go`ï¼Œåœ¨ `database.InitMySQL(...)` åæ·»åŠ ï¼š
```go
database.InitRedis(cfg.Database.Redis.Addr, cfg.Database.Redis.Password, cfg.Database.Redis.DB)
```

##### çŸ¥è¯†ç‚¹

**go-redis åº“**

`go-redis/redis/v8` æ˜¯ Go ç¤¾åŒºæœ€æµè¡Œçš„ Redis å®¢æˆ·ç«¯åº“ã€‚æ ¸å¿ƒç”¨æ³•ï¼š
- `redis.NewClient(&redis.Options{...})` â€” åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹
- `RDB.Ping(ctx)` â€” æµ‹è¯•è¿æ¥æ˜¯å¦æ­£å¸¸
- `Password` ä¸ºç©ºå­—ç¬¦ä¸²æ—¶è‡ªåŠ¨è·³è¿‡è®¤è¯ï¼Œå…¼å®¹æ— å¯†ç çš„ Redis

**ä¸ MySQL åˆå§‹åŒ–çš„è®¾è®¡å¯¹æ¯”**

| | InitMySQL | InitRedis |
| :--- | :--- | :--- |
| å…¨å±€å˜é‡ | `DB *gorm.DB` | `RDB *redis.Client` |
| è¿æ¥æµ‹è¯• | GORM å†…éƒ¨è‡ªåŠ¨æµ‹è¯• | æ‰‹åŠ¨ `Ping(ctx)` |
| è¿æ¥æ±  | éœ€æ‰‹åŠ¨é…ç½®ï¼ˆMaxIdleConns ç­‰ï¼‰ | go-redis å†…ç½®è¿æ¥æ± ï¼Œé»˜è®¤å³å¯ |
| å¤±è´¥å¤„ç† | `log.Fatal` é€€å‡º | `log.Fatal` é€€å‡º |

ä¸¤è€…è®¾è®¡æ€è·¯ä¸€è‡´ï¼šå¯åŠ¨æ—¶åˆå§‹åŒ– â†’ å…¨å±€å•ä¾‹ â†’ å¤±è´¥å³ Fatal â†’ åç»­ä¸šåŠ¡é€šè¿‡ `database.DB` / `database.RDB` è®¿é—®ã€‚

